<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端多媒體管理系統 (高效能版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        body { background-color: #0f172a; color: #f1f5f9; overflow: hidden; user-select: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        /* ★ 優化: 硬體加速類別 */
        .gpu-accelerated { will-change: transform; backface-visibility: hidden; transform: translateZ(0); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef, useCallback, forwardRef, useImperativeHandle, memo } = React;

        // --- 網址模糊化處理 ---
        const _cfg = [
            "aHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tLw==", 
            "dG9ueWtvYmVyL3Jlcy9yZWZzL2hlYWRzL21haW4vdmlkZW9fZGF0YS5qc29u"
        ];
        const GITHUB_JSON_URL = atob(_cfg[0]) + atob(_cfg[1]);
        const STORAGE_KEY = 'cloud_video_manager_data';
        const REPORT_KEY = 'cloud_video_manager_report';

        // --- ★ 優化: 自定義 Hook - useDebounce (防抖) ---
        const useDebounce = (value, delay) => {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => {
                    setDebouncedValue(value);
                }, delay);
                return () => clearTimeout(handler);
            }, [value, delay]);
            return debouncedValue;
        };

        // --- ★ 補回: 自定義 Hook - useResizeObserver ---
        const useResizeObserver = (ref) => {
            const [dimensions, setDimensions] = useState({ width: 0, height: 0 });
            useEffect(() => {
                if (!ref.current) return;
                const resizeObserver = new ResizeObserver((entries) => {
                    if (!entries || entries.length === 0) return;
                    const { width, height } = entries[0].contentRect;
                    setDimensions({ width, height });
                });
                resizeObserver.observe(ref.current);
                return () => resizeObserver.disconnect();
            }, [ref]);
            return dimensions;
        };

        // --- ★ 優化: 指數退避 Fetch 函式 ---
        const fetchWithBackoff = async (url, retries = 3, delay = 1000) => {
            try {
                const response = await fetch(url, { cache: "no-store" });
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                
                const text = await response.text();
                
                const tryParse = (str) => {
                    try { return JSON.parse(str); } catch (e) { return null; }
                };

                let result = tryParse(text);
                if (result) return result;

                console.warn("JSON 直接解析失敗，啟動分層修復機制...");

                const textNoControl = text.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, "");
                result = tryParse(textNoControl);
                if (result) {
                    console.log("策略 2 修復成功");
                    return result;
                }

                const textCleanAll = text.replace(/[\x00-\x1F\x7F]/g, "");
                result = tryParse(textCleanAll);
                if (result) {
                    console.log("策略 3 (強力模式) 修復成功");
                    return result;
                }

                JSON.parse(text);

            } catch (error) {
                const isTruncated = error.message.includes("Unterminated string") || 
                                  error.message.includes("End of data") ||
                                  error.message.includes("Unexpected end of JSON");

                if (retries > 0) {
                    const retryMsg = isTruncated ? "檢測到資料下載不完整 (Unterminated)" : "解析錯誤";
                    console.warn(`${retryMsg}，${delay/1000}秒後重試... (剩餘 ${retries} 次)`);
                    
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(url, retries - 1, delay * 2);
                }
                throw error;
            }
        };

        // --- ★ 新增: 資料驗證與正規化邏輯核心 ---
        const validateAndNormalizeData = (rawData) => {
            const report = {
                timestamp: new Date().toLocaleString(),
                totalRaw: 0,
                success: 0,
                failed: 0,
                logs: [] 
            };

            if (!Array.isArray(rawData)) {
                report.logs.push({ type: 'error', msg: '嚴重錯誤：原始資料不是陣列格式' });
                return { validData: [], report };
            }

            report.totalRaw = rawData.length;
            const validData = [];
            const seenIds = new Set();

            rawData.forEach((item, index) => {
                if (typeof item !== 'object' || item === null) {
                    report.failed++;
                    report.logs.push({ type: 'error', msg: `第 ${index + 1} 筆資料格式錯誤 (非物件)` });
                    return;
                }

                if (!item.id || typeof item.id !== 'string' || item.id.trim() === '') {
                    report.failed++;
                    report.logs.push({ type: 'error', msg: `第 ${index + 1} 筆資料缺少有效 ID`, itemTitle: item.title || '未命名' });
                    return;
                }

                if (seenIds.has(item.id)) {
                    report.failed++;
                    report.logs.push({ type: 'warning', msg: `發現重複的 ID (${item.id})，已自動忽略`, itemTitle: item.title });
                    return;
                }
                seenIds.add(item.id);

                const newItem = { ...item };
                
                if (!newItem.title) {
                    newItem.title = '未命名檔案';
                    report.logs.push({ type: 'info', msg: '標題空白，已自動命名為 "未命名檔案"', itemId: item.id });
                }

                let category = '未分類';
                if (newItem.category && typeof newItem.category === 'string') {
                    let normalizedCat = newItem.category.replace(/\\/g, '/').trim();
                    normalizedCat = normalizedCat.replace(/^\/+|\/+$/g, ''); 
                    if (normalizedCat !== '') category = normalizedCat;
                }
                newItem.category = category;

                const validTypes = ['video', 'image', 'audio', 'pdf'];
                if (!newItem.type || !validTypes.includes(newItem.type)) {
                    if (newItem.type) {
                        report.logs.push({ type: 'warning', msg: `未知類型 "${newItem.type}"，已修正為 "video"`, itemTitle: newItem.title });
                    }
                    newItem.type = 'video'; 
                }

                validData.push(newItem);
            });

            report.success = validData.length;
            return { validData, report };
        };

        // --- 內建輕量級虛擬列表 ---
        const FixedSizeList = forwardRef(({ height, width, itemCount, itemSize, children: Row, className, style, itemData }, ref) => {
            const [scrollTop, setScrollTop] = useState(0);
            const containerRef = useRef(null);
            useImperativeHandle(ref, () => ({ scrollTo: (scrollOffset) => { if (containerRef.current) containerRef.current.scrollTop = scrollOffset; } }));
            const onScroll = (e) => setScrollTop(e.currentTarget.scrollTop);
            const totalHeight = itemCount * itemSize;
            const startIndex = Math.floor(scrollTop / itemSize);
            const buffer = 5; 
            const visibleNodeCount = Math.ceil(height / itemSize);
            const startNode = Math.max(0, startIndex - buffer);
            const endNode = Math.min(itemCount, startIndex + visibleNodeCount + buffer);
            const items = [];
            for (let i = startNode; i < endNode; i++) {
                items.push(<Row key={i} index={i} style={{ position: 'absolute', top: i * itemSize, left: 0, width: '100%', height: itemSize }} data={itemData} />);
            }
            return (
                <div ref={containerRef} className={className} style={{ ...style, width, height, overflowY: 'auto', overflowX: 'hidden', position: 'relative' }} onScroll={onScroll}>
                    <div style={{ height: totalHeight, width: '100%', position: 'relative' }}>{items}</div>
                </div>
            );
        });

        // --- 圖示定義 ---
        const createIcon = (paths) => ({ size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{paths}</svg>
        );
        const Icons = {
            Play: createIcon(<polygon points="5 3 19 12 5 21 5 3"></polygon>),
            Image: createIcon(<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></>),
            Music: createIcon(<><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></>),
            FileText: createIcon(<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></>),
            Eye: createIcon(<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></>),
            Search: createIcon(<><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></>),
            Folder: createIcon(<path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 2H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path>),
            FileVideo: createIcon(<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="m10 11 5 3-5 3v-6Z"></path></>),
            X: createIcon(<><line x1="18" x2="6" y1="6" y2="18"></line><line x1="6" x2="18" y1="6" y2="18"></line></>),
            LayoutList: createIcon(<><rect width="7" height="7" x="3" y="3" rx="1"></rect><rect width="7" height="7" x="3" y="14" rx="1"></rect><path d="M14 4h7"></path><path d="M14 9h7"></path><path d="M14 15h7"></path><path d="M14 20h7"></path></>),
            LayoutGrid: createIcon(<><rect width="7" height="7" x="3" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="14" rx="1"></rect><rect width="7" height="7" x="3" y="14" rx="1"></rect></>),
            RefreshCw: createIcon(<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></>),
            ChevronRight: createIcon(<path d="m9 18 6-6-6-6"></path>),
            ChevronDown: createIcon(<path d="m6 9 6 6 6-6"></path>),
            FolderOpen: createIcon(<><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-3.25 7a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2"></path></>),
            CornerDownRight: createIcon(<><polyline points="15 10 20 15 15 20"></polyline><path d="M4 4v7a4 4 0 0 0 4 4h12"></path></>),
            Clock: createIcon(<><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></>),
            PanelLeftClose: createIcon(<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><path d="M9 3v18"></path><path d="m16 15-3-3 3-3"></path></>),
            PanelLeftOpen: createIcon(<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><path d="M9 3v18"></path><path d="m14 15 3-3-3-3"></path></>),
            Trash2: createIcon(<><path d="M3 6h18"></path><path d="M19 6v14c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V6"></path><path d="M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2"></path><line x1="10" x2="10" y1="11" y2="17"></line><line x1="14" x2="14" y1="11" y2="17"></line></>),
            ArrowUpDown: createIcon(<><path d="m21 16-4 4-4-4"></path><path d="M17 20V4"></path><path d="m3 8 4-4 4 4"></path><path d="M7 4v16"></path></>),
            AlertCircle: createIcon(<><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></>),
            Filter: createIcon(<polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>),
            ExternalLink: createIcon(<><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></>),
            RotateCcw: createIcon(<path d="M1 4v6h6"></path>),
            ArrowLeft: createIcon(<><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></>),
            SlidersHorizontal: createIcon(<><line x1="21" y1="4" x2="14" y2="4"></line><line x1="10" y1="4" x2="3" y2="4"></line><line x1="21" y1="12" x2="12" y2="12"></line><line x1="8" y1="12" x2="3" y2="12"></line><line x1="21" y1="20" x2="16" y2="20"></line><line x1="12" y1="20" x2="3" y2="20"></line><line x1="14" y1="2" x2="14" y2="6"></line><line x1="8" y1="10" x2="8" y2="14"></line><line x1="16" y1="18" x2="16" y2="22"></line></>),
            Check: createIcon(<polyline points="20 6 9 17 4 12"></polyline>),
            ClipboardList: createIcon(<><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></>),
        };
        const { Play, Image: ImageIcon, Music, FileText, Eye, Search, Folder, FileVideo, X, LayoutList, LayoutGrid, RefreshCw, ChevronRight, ChevronDown, FolderOpen, CornerDownRight, Clock, PanelLeftClose, PanelLeftOpen, Trash2, ArrowUpDown, AlertCircle, Filter, ExternalLink, RotateCcw, ArrowLeft, SlidersHorizontal, Check, ClipboardList } = Icons;

        // --- ★ 新增: 確認清空對話框組件 ---
        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-[80] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl w-full max-w-sm flex flex-col transform transition-all scale-100 overflow-hidden">
                        <div className="p-6 flex flex-col items-center text-center">
                            <div className="w-12 h-12 rounded-full bg-red-900/30 flex items-center justify-center mb-4 border border-red-500/20">
                                <Trash2 size={24} className="text-red-500" />
                            </div>
                            <h3 className="text-lg font-bold text-white mb-2">{title}</h3>
                            <p className="text-sm text-slate-400 leading-relaxed">
                                {message}
                            </p>
                        </div>
                        <div className="flex border-t border-slate-700 bg-slate-800/50">
                            <button 
                                onClick={onClose} 
                                className="flex-1 py-3 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 transition-colors border-r border-slate-700"
                            >
                                取消
                            </button>
                            <button 
                                onClick={onConfirm} 
                                className="flex-1 py-3 text-sm font-bold text-red-400 hover:text-red-300 hover:bg-red-900/20 transition-colors"
                            >
                                確定清空
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 同步報告視窗組件 ---
        const ReportModal = ({ report, onClose }) => {
            if (!report) return null;

            return (
                <div className="fixed inset-0 z-[60] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[80vh]">
                        <div className="flex items-center justify-between px-6 py-4 border-b border-slate-700 bg-slate-800 rounded-t-xl">
                            <div className="flex items-center space-x-2 text-white font-bold text-lg">
                                <ClipboardList size={20} className="text-blue-400" />
                                <span>匯入情況報告</span>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">
                                <X size={20} />
                            </button>
                        </div>
                        
                        <div className="p-6 overflow-y-auto custom-scrollbar">
                            <div className="grid grid-cols-3 gap-4 mb-6">
                                <div className="bg-slate-800 p-3 rounded-lg text-center border border-slate-700">
                                    <div className="text-xs text-slate-400 mb-1">總項目數</div>
                                    <div className="text-xl font-bold text-white">{report.totalRaw}</div>
                                </div>
                                <div className="bg-green-900/30 p-3 rounded-lg text-center border border-green-800/50">
                                    <div className="text-xs text-green-400 mb-1">成功匯入</div>
                                    <div className="text-xl font-bold text-green-400">{report.success}</div>
                                </div>
                                <div className={`p-3 rounded-lg text-center border ${report.failed > 0 ? 'bg-red-900/30 border-red-800/50' : 'bg-slate-800 border-slate-700'}`}>
                                    <div className={`text-xs mb-1 ${report.failed > 0 ? 'text-red-400' : 'text-slate-400'}`}>失敗/忽略</div>
                                    <div className={`text-xl font-bold ${report.failed > 0 ? 'text-red-400' : 'text-slate-200'}`}>{report.failed}</div>
                                </div>
                            </div>

                            <div className="text-xs text-slate-500 mb-2 flex justify-between items-center">
                                <span>同步時間: {report.timestamp}</span>
                            </div>

                            {report.logs.length > 0 ? (
                                <div className="space-y-2">
                                    <div className="text-sm font-bold text-slate-300 mb-2">詳細日誌：</div>
                                    {report.logs.map((log, i) => (
                                        <div key={i} className={`text-xs p-2 rounded border ${log.type === 'error' ? 'bg-red-900/20 border-red-900/30 text-red-200' : (log.type === 'warning' ? 'bg-yellow-900/20 border-yellow-900/30 text-yellow-200' : 'bg-blue-900/20 border-blue-900/30 text-blue-200')}`}>
                                            <span className={`font-bold mr-1`}>[{log.type === 'error' ? '錯誤' : (log.type === 'warning' ? '警告' : '修正')}]</span>
                                            {log.msg}
                                            {log.itemTitle && <span className="block mt-0.5 opacity-70">項目: {log.itemTitle}</span>}
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <div className="text-center py-8 text-slate-500 bg-slate-800/50 rounded-lg border border-slate-700 border-dashed">
                                    <Check size={24} className="mx-auto mb-2 text-green-500 opacity-50" />
                                    <span>完美匯入！沒有發現任何問題。</span>
                                </div>
                            )}
                        </div>
                        
                        <div className="p-4 border-t border-slate-700 bg-slate-800 rounded-b-xl flex justify-end">
                            <button onClick={onClose} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm rounded-md transition-colors">
                                關閉
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const getFileIcon = (type) => {
            switch(type) {
                case 'image': return ImageIcon;
                case 'audio': return Music;
                case 'pdf': return FileText;
                default: return Play;
            }
        };

        const getFileColor = (type) => {
             switch(type) {
                case 'image': return "text-purple-400";
                case 'audio': return "text-green-400";
                case 'pdf': return "text-orange-400";
                default: return "text-blue-500";
            }
        }

        const SearchMenu = memo(({ searchQuery, onSearchChange, onClear }) => {
            const [isOpen, setIsOpen] = useState(false);
            const menuRef = useRef(null);
            const inputRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            useEffect(() => {
                if (isOpen && inputRef.current) {
                    setTimeout(() => inputRef.current.focus(), 100);
                }
            }, [isOpen]);

            const hasQuery = searchQuery.trim() !== '';

            return (
                <div className="relative" ref={menuRef}>
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        className={`flex items-center justify-center p-2 rounded-md border border-transparent transition-colors ${hasQuery || isOpen ? 'bg-slate-700 text-blue-400 border-slate-600' : 'text-slate-400 hover:bg-slate-700 hover:text-white border-transparent'}`}
                        title="搜尋檔案"
                    >
                        <Search size={20} />
                    </button>

                    {isOpen && (
                        <div className="absolute right-0 top-full mt-2 w-72 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-50 p-3 animate-fade-in origin-top-right">
                            <div className="relative">
                                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={16} />
                                <input 
                                    ref={inputRef}
                                    type="text" 
                                    placeholder="輸入關鍵字..." 
                                    className="w-full pl-9 pr-8 py-2 bg-slate-900 rounded-md text-sm outline-none border border-slate-700 focus:border-blue-500 text-slate-200 placeholder-slate-500 transition-all" 
                                    value={searchQuery} 
                                    onChange={onSearchChange}
                                />
                                {hasQuery && (
                                    <button 
                                        onClick={() => { onClear(); inputRef.current.focus(); }}
                                        className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-300"
                                    >
                                        <X size={14} />
                                    </button>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        });

        const DisplaySettingsMenu = memo(({ sortOption, setSortOption, filterType, setFilterType }) => {
            const [isOpen, setIsOpen] = useState(false);
            const menuRef = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (menuRef.current && !menuRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const sortOptions = [
                { value: 'date_desc', label: '日期 (新→舊)' },
                { value: 'date_asc', label: '日期 (舊→新)' },
                { value: 'name_asc', label: '名稱 (A→Z)' },
                { value: 'name_desc', label: '名稱 (Z→A)' },
            ];

            const filterOptions = [
                { value: 'all', label: '全部類型' },
                { value: 'video', label: '僅影片' },
                { value: 'image', label: '僅圖片' },
                { value: 'audio', label: '僅音訊' },
                { value: 'pdf', label: '僅文件' },
            ];

            return (
                <div className="relative" ref={menuRef}>
                    <button
                        onClick={() => setIsOpen(!isOpen)}
                        className={`flex items-center space-x-1 px-2 py-2 rounded-md border border-transparent transition-colors ${isOpen ? 'bg-slate-700 text-white border-slate-600' : 'text-slate-400 hover:bg-slate-700 hover:text-white border-transparent'}`}
                        title="顯示設定"
                    >
                        <SlidersHorizontal size={20} />
                        <ChevronDown size={12} className={`transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} />
                    </button>

                    {isOpen && (
                        <div className="absolute right-0 top-full mt-2 w-56 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-50 py-2 animate-fade-in origin-top-right">
                            <div className="px-3 py-1.5 text-xs font-bold text-slate-500 uppercase tracking-wider">排序方式</div>
                            {sortOptions.map(opt => (
                                <button
                                    key={opt.value}
                                    onClick={() => { setSortOption(opt.value); setIsOpen(false); }}
                                    className="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white flex items-center justify-between group"
                                >
                                    <span>{opt.label}</span>
                                    {sortOption === opt.value && <Check size={14} className="text-blue-400" />}
                                </button>
                            ))}
                            <div className="my-1 border-t border-slate-700"></div>
                            <div className="px-3 py-1.5 text-xs font-bold text-slate-500 uppercase tracking-wider">過濾類型</div>
                            {filterOptions.map(opt => (
                                <button
                                    key={opt.value}
                                    onClick={() => { setFilterType(opt.value); setIsOpen(false); }}
                                    className="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 hover:text-white flex items-center justify-between group"
                                >
                                    <span>{opt.label}</span>
                                    {filterType === opt.value && <Check size={14} className="text-blue-400" />}
                                </button>
                            ))}
                        </div>
                    )}
                </div>
            );
        });

        // --- ★ 修改: UniversalViewer (統一使用 Iframe + 新視窗邏輯) ---
        const UniversalViewer = ({ file, onClose }) => {
            if (!file) return null;
            
            // 統一預覽連結 (Google Drive Preview)
            const previewUrl = `https://drive.google.com/file/d/${file.id}/preview`;
            
            // 新視窗開啟邏輯 (使用標準 window.open)
            const handleOpenNewWindow = () => {
                const w = 720;
                const h = 480;
                const left = (window.screen.width - w) / 2;
                const top = (window.screen.height - h) / 2;
                window.open(previewUrl, '_blank', `width=${w},height=${h},top=${top},left=${left},resizable,scrollbars`);
            };

            return (
                <div 
                    className="fixed inset-0 z-[100] bg-black/95 flex flex-col animate-fade-in"
                >
                    {/* Header */}
                    <div className="flex items-center justify-between px-4 py-3 bg-slate-800/80 backdrop-blur-sm border-b border-slate-700/50 flex-shrink-0 z-10">
                        <div className="text-slate-200 font-medium truncate flex-1 mr-4">{file.title}</div>
                        <div className="flex items-center space-x-3">
                            <button onClick={handleOpenNewWindow} className="flex items-center space-x-1.5 px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-md text-sm transition-colors shadow-sm">
                                <ExternalLink size={16} /><span className="hidden sm:inline">新視窗開啟</span>
                            </button>
                            <button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors">
                                <X size={24} />
                            </button>
                        </div>
                    </div>
                    
                    {/* Content (Unified Iframe) */}
                    <div className="flex-1 overflow-hidden relative flex items-center justify-center bg-black p-0 group/iframe-container">
                        <iframe 
                            src={previewUrl} 
                            className="w-full h-full border-0" 
                            allow="autoplay; fullscreen" 
                            title={file.title}
                        />
                    </div>
                </div>
            );
        };

        // --- ★ 保留: MediaThumbnail (縮圖載入策略維持不變) ---
        const MediaThumbnail = memo(({ file }) => {
            const [imageError, setImageError] = useState(false);
            const id = file.id;
            const isImage = file.type === 'image';
            const showThumb = (file.type === 'video' || file.type === 'image') && !imageError && id && id.length > 5;
            const thumbnailUrl = showThumb ? `https://lh3.googleusercontent.com/d/${id}=w320` : null;
            const OverlayIcon = getFileIcon(file.type);
            const isVideo = file.type === 'video' || !file.type; 

            return (
                <div className="aspect-video bg-slate-700 relative group overflow-hidden rounded-t-xl flex items-center justify-center">
                    {thumbnailUrl ? (
                        <img 
                            src={thumbnailUrl} 
                            alt="" 
                            className="w-full h-full object-cover group-hover:scale-105 transition-transform" 
                            onError={() => setImageError(true)} 
                            loading="lazy" 
                            decoding="async" 
                        />
                    ) : (
                        <div className="flex flex-col items-center justify-center text-slate-500">
                             {isVideo ? <FileVideo size={32} /> : <OverlayIcon size={32} />}
                        </div>
                    )}
                    <div className="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center shadow-lg transform scale-90 group-hover:scale-100 transition-transform ${isImage ? 'bg-purple-500' : 'bg-blue-500'}`}>
                            {isImage ? <Eye size={18} className="text-white" /> : <Play size={18} className="ml-1 text-white" />}
                        </div>
                    </div>
                    <div className="absolute top-2 right-2 px-1.5 py-0.5 bg-black/60 backdrop-blur-sm rounded text-[10px] text-white uppercase font-bold">
                        {file.type || 'VIDEO'}
                    </div>
                </div>
            );
        });

        const ListThumbnail = memo(({ file }) => {
            const [imageError, setImageError] = useState(false);
            const id = file.id;
            const showThumb = (file.type === 'video' || file.type === 'image') && !imageError;
            const thumbnailUrl = showThumb ? `https://lh3.googleusercontent.com/d/${id}=w320` : null;
            const TypeIcon = getFileIcon(file.type);
            
            return (
                <div className="w-24 h-14 bg-slate-700 rounded overflow-hidden flex-shrink-0 border border-slate-600 flex items-center justify-center relative">
                    {thumbnailUrl ? (
                        <img src={thumbnailUrl} className="w-full h-full object-cover" onError={() => setImageError(true)} loading="lazy" decoding="async" />
                    ) : (
                        <TypeIcon size={20} className="text-slate-500" />
                    )}
                    <div className={`absolute bottom-0 right-0 w-3 h-3 ${file.type === 'image' ? 'bg-purple-500' : 'bg-blue-500'} rounded-tl`}></div>
                </div>
            );
        });

        // --- FolderTreeItem ---
        const FolderTreeItem = memo(({ node, level, expandedFolders, activeCategory, onToggle, onSelect }) => {
            const hasChildren = Object.keys(node.children).length > 0;
            const isOpen = expandedFolders.has(node.fullPath);
            const isActive = activeCategory === node.fullPath;
            const indentSize = level * 16 + 12;

            const itemRef = useRef(null);

            useEffect(() => {
                if (isActive && itemRef.current) {
                    const timer = setTimeout(() => {
                        itemRef.current.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center',
                            inline: 'nearest'
                        });
                    }, 100);
                    return () => clearTimeout(timer);
                }
            }, [isActive]);

            return (
                <div className="select-none">
                    <div 
                        ref={itemRef} 
                        className={`group flex items-center py-1.5 pr-3 text-sm transition-colors cursor-pointer border-l-[3px] ${isActive ? 'bg-blue-500/10 text-blue-200 border-blue-500' : 'text-slate-400 hover:bg-slate-800 border-transparent hover:text-slate-200'}`} 
                        style={{ paddingLeft: `${indentSize}px` }} 
                        onClick={() => onSelect(node.fullPath)}
                    >
                        <div 
                            className={`w-5 h-5 mr-1 flex items-center justify-center rounded hover:bg-white/10 shrink-0 transition-transform ${!hasChildren ? 'invisible' : ''}`}
                            onClick={(e) => { e.stopPropagation(); onToggle(node.fullPath); }}
                        >
                            {isOpen ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
                        </div>
                        <div className="mr-2 shrink-0">
                             {isActive ? <FolderOpen size={18} className="text-blue-400" /> : <Folder size={18} className="text-slate-400 group-hover:text-slate-300" />}
                        </div>
                        <span className="truncate flex-1">{node.name}</span>
                        {node.totalCount > 0 && (
                             <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-slate-700/50 text-slate-500 ml-2">{node.totalCount}</span>
                        )}
                    </div>
                    {hasChildren && isOpen && (
                        <div>
                            {Object.values(node.children).sort((a,b)=>a.name.localeCompare(b.name,'zh-TW')).map(child => (
                                <FolderTreeItem key={child.fullPath} node={child} level={level+1} expandedFolders={expandedFolders} activeCategory={activeCategory} onToggle={onToggle} onSelect={onSelect} />
                            ))}
                        </div>
                    )}
                </div>
            );
        });

        // --- VirtualGallery ---
        const VirtualGallery = memo(({ items, viewMode, onItemClick, onFolderClick }) => {
            const containerRef = useRef(null);
            const { width, height } = useResizeObserver(containerRef);
            const listRef = useRef(null);

            useEffect(() => { if (listRef.current) listRef.current.scrollTo(0); }, [items, viewMode]);

            if (items.length === 0) {
                return (
                    <div ref={containerRef} className="h-full flex flex-col items-center justify-center text-slate-500 space-y-4">
                         <FolderOpen size={64} className="opacity-20" />
                        <div className="text-center text-lg font-medium opacity-50">尚無符合條件的內容</div>
                    </div>
                )
            }

            const isSmallScreen = width > 0 && width < 640; 
            const paddingX = isSmallScreen ? 16 : 48; 
            const gap = isSmallScreen ? 10 : 16;
            
            const availableWidth = width - paddingX;
            const baseMinItemWidth = isSmallScreen ? 135 : 240; 
            
            let columns = Math.floor((availableWidth + gap) / (baseMinItemWidth + gap));
            
            if (columns < 3) {
                const minWidthFor3Cols = (150 * 3) + (gap * 2);
                
                if (availableWidth >= minWidthFor3Cols) {
                    columns = 3;
                } else {
                    columns = Math.floor((availableWidth + gap) / (150 + gap));
                }
            }
            
            columns = Math.max(columns, 1); 
            const itemWidth = (availableWidth - (columns - 1) * gap) / columns;
            
            const imageHeight = itemWidth * (9 / 16);
            const textContentHeight = isSmallScreen ? 85 : 100;
            const gridRowHeight = imageHeight + textContentHeight + gap;
            const gridRowCount = Math.ceil(items.length / columns);

            const RowList = ({ index, style, data }) => {
                const item = data[index];
                if (item.type === 'folder') {
                    return (
                        <div style={style} className="px-2 py-1">
                            <div onClick={() => onFolderClick(item.fullPath)} className="flex items-center h-full bg-slate-800/50 hover:bg-slate-700 border-b border-slate-700/50 cursor-pointer px-4 rounded transition-colors group">
                                <div className="w-16 flex justify-center"><Folder size={20} className="text-yellow-500/80" /></div>
                                <div className="flex-1 ml-4 flex items-center">
                                    <CornerDownRight size={14} className="text-slate-600 mr-2" />
                                    <span className="text-slate-300 font-medium group-hover:text-blue-400">{item.name}</span>
                                </div>
                                <div className="text-slate-500 text-xs mr-4">資料夾 ({item.totalCount})</div>
                            </div>
                        </div>
                    );
                }
                const TypeIcon = getFileIcon(item.type);
                return (
                    <div style={style} className="px-2 py-1">
                        <div onClick={() => onItemClick(item)} className="flex items-center h-full hover:bg-slate-700/50 border-b border-slate-700/50 cursor-pointer px-4 rounded transition-colors group">
                            <div className="w-24 shrink-0"><ListThumbnail file={item} /></div>
                            <div className="flex-1 ml-4 min-w-0">
                                <div className="font-semibold text-slate-200 group-hover:text-blue-400 truncate flex items-center">
                                    <TypeIcon size={14} className={`mr-2 ${getFileColor(item.type)}`} />
                                    {item.title}
                                </div>
                                <div className="text-xs text-slate-500 mt-1 flex items-center"><Folder size={12} className="mr-1"/>{item.category.split('/').pop()}</div>
                                <div className="md:hidden text-[10px] text-slate-600 mt-1">{item.date}</div>
                            </div>
                            <div className="hidden md:block w-32 text-right text-slate-500 text-sm font-mono">{item.date}</div>
                        </div>
                    </div>
                );
            };

            const RowGrid = ({ index, style, data }) => {
                const { items, columns, itemWidth, gap, paddingX, height } = data;
                const startIndex = index * columns;
                const rowItems = items.slice(startIndex, startIndex + columns);

                return (
                    <div style={{ ...style, paddingLeft: paddingX / 2, paddingRight: paddingX / 2 }} className="flex">
                        {rowItems.map((item, i) => {
                            const isLast = i === rowItems.length - 1;
                            const marginStyle = isLast ? {} : { marginRight: gap };
                            const cardStyle = { width: itemWidth, height: height - gap, ...marginStyle };

                            if (item.type === 'folder') {
                                return (
                                    <div key={item.fullPath} style={cardStyle} onClick={() => onFolderClick(item.fullPath)} className="bg-slate-800 border border-slate-700 rounded-xl p-3 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-700 hover:border-slate-600 transition-all group shrink-0">
                                        <Folder size={48} className="text-yellow-500/80 group-hover:scale-110 transition-transform mb-2" />
                                        <span className="font-medium text-slate-300 text-sm text-center truncate w-full group-hover:text-blue-400">{item.name}</span>
                                        <span className="text-[10px] text-slate-600 mt-0.5">{item.totalCount} 項目</span>
                                    </div>
                                );
                            }
                            return (
                                <div key={item.id} style={cardStyle} onClick={() => onItemClick(item)} className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden hover:border-blue-500 transition-all cursor-pointer group shadow-sm hover:shadow-blue-500/10 shrink-0 flex flex-col">
                                    <MediaThumbnail file={item} />
                                    <div className="p-3 flex-1 flex flex-col">
                                        <div className="text-sm font-semibold truncate group-hover:text-blue-400 transition-colors" title={item.title}>{item.title}</div>
                                        <div className="mt-auto pt-2 flex items-center justify-between">
                                            <div className="text-[10px] text-slate-500 truncate flex-1 flex items-center"><Folder size={10} className="mr-1"/>{item.category.split('/').pop()}</div>
                                            <div className="text-[10px] text-slate-600 font-mono ml-2">{item.date}</div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                );
            };

            return (
                <div ref={containerRef} className="h-full w-full">
                    {width > 0 && height > 0 && (
                        viewMode === 'list' ? (
                            <FixedSizeList ref={listRef} height={height} width={width} itemCount={items.length} itemSize={80} itemData={items} className="custom-scrollbar">
                                {RowList}
                            </FixedSizeList>
                        ) : (
                            <FixedSizeList ref={listRef} height={height} width={width} itemCount={gridRowCount} itemSize={gridRowHeight} itemData={{ items, columns, itemWidth, gap, paddingX, height: gridRowHeight }} className="custom-scrollbar">
                                {RowGrid}
                            </FixedSizeList>
                        )
                    )}
                </div>
            );
        });

        // --- App 主程式 ---
        function App() {
            const [videoData, setVideoData] = useState([]);
            const [isSyncing, setIsSyncing] = useState(false);
            const [statusMsg, setStatusMsg] = useState(null);
            const [activeCategory, setActiveCategory] = useState('全部');
            const [searchQuery, setSearchQuery] = useState('');
            const [viewMode, setViewMode] = useState('list');
            const [sortOption, setSortOption] = useState('date_desc');
            const [filterType, setFilterType] = useState('all');
            const [viewingFile, setViewingFile] = useState(null);
            const [expandedFolders, setExpandedFolders] = useState(new Set());
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            
            const [importReport, setImportReport] = useState(null);
            const [showReport, setShowReport] = useState(false);
            
            // ★ 新增: 控制清空確認視窗的狀態
            const [showClearModal, setShowClearModal] = useState(false);

            const debouncedSearchQuery = useDebounce(searchQuery, 300);

            useEffect(() => {
                const handleContextMenu = (e) => e.preventDefault();
                document.addEventListener('contextmenu', handleContextMenu);
                return () => document.removeEventListener('contextmenu', handleContextMenu);
            }, []);

            useEffect(() => { if (statusMsg) { const t = setTimeout(() => setStatusMsg(null), 5000); return () => clearTimeout(t); } }, [statusMsg]);

            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                const savedReport = localStorage.getItem(REPORT_KEY);
                
                if (savedReport) {
                    try { setImportReport(JSON.parse(savedReport)); } catch(e) {}
                }

                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        setVideoData(parsed);
                        if (parsed.length === 0) fetchFromGitHub(true);
                    } catch(e) { fetchFromGitHub(true); }
                } else {
                    fetchFromGitHub(true);
                }
            }, []);

            useEffect(() => { localStorage.setItem(STORAGE_KEY, JSON.stringify(videoData)); }, [videoData]);
            
            useEffect(() => { 
                if(importReport) localStorage.setItem(REPORT_KEY, JSON.stringify(importReport)); 
            }, [importReport]);

            const handleCategorySelect = useCallback((path) => {
                setActiveCategory(path);
                if (window.innerWidth < 768) {
                    setIsSidebarOpen(false);
                }

                if (path === '全部') return;
                setExpandedFolders(prev => {
                    const next = new Set(prev);
                    const parts = path.split('/');
                    let current = '';
                    parts.forEach(p => {
                        current = current ? `${current}/${p}` : p;
                        next.add(current);
                    });
                    return next;
                });
            }, []);

            const handleToggleFolder = useCallback((path) => {
                setExpandedFolders(prev => {
                    const next = new Set(prev);
                    next.has(path) ? next.delete(path) : next.add(path);
                    return next;
                });
            }, []);

            const handleGoUp = useCallback(() => {
                if (activeCategory === '全部') return;
                const parts = activeCategory.split('/');
                if (parts.length <= 1) {
                    handleCategorySelect('全部');
                } else {
                    parts.pop();
                    handleCategorySelect(parts.join('/'));
                }
            }, [activeCategory, handleCategorySelect]);

            const handleSearchChange = useCallback((e) => setSearchQuery(e.target.value), []);
            const handleSearchClear = useCallback(() => setSearchQuery(''), []);

            const fetchFromGitHub = async (isAuto = false) => {
                if (isSyncing) return;
                setIsSyncing(true);
                try {
                    const rawData = await fetchWithBackoff(GITHUB_JSON_URL);
                    
                    const { validData, report } = validateAndNormalizeData(rawData);
                    
                    setVideoData(validData);
                    setImportReport(report);
                    setShowReport(true); // Added this

                    if (report.failed > 0) {
                         setStatusMsg({ type: 'error', text: `同步完成：成功 ${report.success} 筆，忽略 ${report.failed} 筆問題資料。` });
                    } else {
                         setStatusMsg({ type: 'success', text: `同步成功！共載入 ${report.success} 筆資料。` });
                    }
                } catch (err) {
                    console.error("同步失敗:", err);
                    setStatusMsg({ type: 'error', text: `同步失敗：${err.message}` });
                } finally {
                    setIsSyncing(false);
                }
            };
            
            // ★ 新增: 處理清空資料確認後的邏輯
            const handleClearConfirm = useCallback(() => {
                setVideoData([]);
                localStorage.setItem(STORAGE_KEY, JSON.stringify([]));
                // 這裡選擇不清空報告，以便使用者知道最近一次匯入的狀況，若需清空也可加入 setImportReport(null);
                setShowClearModal(false);
                setStatusMsg({ type: 'success', text: '資料已成功清空。' });
            }, []);

            const folderTree = useMemo(() => {
                const tree = {};
                videoData.forEach(v => {
                    const parts = (v.category || '未分類').split('/');
                    let curr = tree, path = "";
                    parts.forEach((p, i) => {
                        path = path ? `${path}/${p}` : p;
                        if (!curr[p]) curr[p] = { name: p, fullPath: path, totalCount: 0, children: {} };
                        curr[p].totalCount++;
                        curr = curr[p].children;
                    });
                });
                return tree;
            }, [videoData]);

            const displayItems = useMemo(() => {
                let folders = [];
                const showFolders = debouncedSearchQuery === '';

                if (showFolders) {
                    if (activeCategory === '全部') {
                        folders = Object.values(folderTree);
                    } else {
                        const parts = activeCategory.split('/');
                        let currentLevel = folderTree;
                        let targetNode = null;
                        for (let i = 0; i < parts.length; i++) {
                            const part = parts[i];
                            if (currentLevel[part]) {
                                if (i === parts.length - 1) targetNode = currentLevel[part];
                                currentLevel = currentLevel[part].children;
                            } else break;
                        }
                        folders = targetNode ? Object.values(targetNode.children) : [];
                    }
                    folders.sort((a, b) => {
                        if (sortOption === 'name_desc') return b.name.localeCompare(a.name, 'zh-TW');
                        return a.name.localeCompare(b.name, 'zh-TW');
                    });
                }
                const formattedFolders = folders.map(f => ({ ...f, type: 'folder' }));

                const filteredItems = videoData.filter(v => {
                    const matchCat = activeCategory === '全部' || (v.category || '未分類').startsWith(activeCategory); 
                    const matchSearch = (v.title || '').toLowerCase().includes(debouncedSearchQuery.toLowerCase());
                    const matchType = filterType === 'all' || v.type === filterType || (!v.type && filterType === 'video'); 
                    
                    if (activeCategory !== '全部' && debouncedSearchQuery === '') {
                         const isDirectChild = (v.category || '未分類') === activeCategory;
                         return isDirectChild && matchType;
                    }
                    return matchCat && matchSearch && matchType;
                });

                filteredItems.sort((a,b) => {
                    if (sortOption === 'date_desc') return new Date(b.date || 0) - new Date(a.date || 0);
                    if (sortOption === 'date_asc') return new Date(a.date || 0) - new Date(b.date || 0);
                    return sortOption === 'name_asc' ? (a.title || '').localeCompare(b.title || '','zh-TW') : (b.title || '').localeCompare(a.title || '','zh-TW');
                });
                const formattedItems = filteredItems.map(v => ({ ...v, type: v.type || 'video' }));

                return [...formattedFolders, ...formattedItems];

            }, [videoData, activeCategory, debouncedSearchQuery, sortOption, folderTree, filterType]);

            const handleItemClick = useCallback((file) => setViewingFile(file), []);

            return (
                <div className="flex h-screen overflow-hidden relative">
                    {/* ★ 彈窗與覆蓋層 */}
                    {showReport && <ReportModal report={importReport} onClose={() => setShowReport(false)} />}
                    {showClearModal && (
                        <ConfirmModal 
                            isOpen={showClearModal}
                            onClose={() => setShowClearModal(false)}
                            onConfirm={handleClearConfirm}
                            title="確定清空所有資料？"
                            message="此動作將會移除目前列表中的所有項目，且無法復原。確定要繼續嗎？"
                        />
                    )}
                    
                    {viewingFile && <UniversalViewer file={viewingFile} onClose={() => setViewingFile(null)} />}

                    {statusMsg && (
                        <div className="fixed top-6 left-0 right-0 z-[110] flex justify-center px-4 pointer-events-none animate-fade-in">
                            <div className={`pointer-events-auto max-w-full md:max-w-md px-5 py-3 rounded-2xl shadow-2xl flex items-center gap-3 border ${statusMsg.type === 'success' ? 'bg-green-900/95 border-green-500/50 text-green-100' : 'bg-red-900/95 border-red-500/50 text-red-100'} backdrop-blur-md`}>
                                <AlertCircle size={20} className="flex-shrink-0" />
                                <span className="text-sm font-medium flex-1 break-words leading-snug">{statusMsg.text}</span>
                                <button onClick={() => setStatusMsg(null)} className="hover:opacity-70 p-1 flex-shrink-0"><X size={16}/></button>
                            </div>
                        </div>
                    )}

                    {isSidebarOpen && (
                        <div 
                            className="fixed inset-0 bg-black/60 z-40 md:hidden backdrop-blur-sm animate-fade-in"
                            onClick={() => setIsSidebarOpen(false)}
                        />
                    )}

                    <aside 
                        className={`
                            bg-slate-800 border-r border-slate-700 flex flex-col transition-all duration-300 z-50
                            fixed inset-y-0 left-0 h-full md:relative
                            ${isSidebarOpen 
                                ? 'translate-x-0 w-72 shadow-2xl md:shadow-none' 
                                : '-translate-x-full w-72 md:w-0 md:translate-x-0 md:opacity-0 md:overflow-hidden'}
                        `}
                    >
                        <div className="p-6 border-b border-slate-700 font-bold text-lg flex items-center justify-between">
                            <div className="flex items-center space-x-2">
                                <Play size={20} className="text-blue-500" fill="currentColor" />
                                <span className="whitespace-nowrap">雲端多媒體庫</span>
                            </div>
                            <button 
                                onClick={() => setIsSidebarOpen(false)} 
                                className="md:hidden p-1 text-slate-400 hover:text-white hover:bg-slate-700 rounded-full transition-colors"
                            >
                                <X size={20} />
                            </button>
                        </div>
                        <nav className="flex-1 overflow-y-auto p-3 custom-scrollbar">
                            <button onClick={()=>handleCategorySelect('全部')} className={`w-full flex items-center space-x-2 px-3 py-2 rounded-md mb-4 whitespace-nowrap ${activeCategory==='全部' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-700'}`}>
                                <LayoutGrid size={18}/> <span className="font-bold">所有檔案 ({videoData.length})</span>
                            </button>
                            <div className="text-xs text-slate-500 font-bold px-3 mb-2 uppercase tracking-wider">資料夾目錄</div>
                            {Object.values(folderTree).sort((a,b)=>a.name.localeCompare(b.name,'zh-TW')).map(node => (
                                <FolderTreeItem key={node.fullPath} node={node} level={0} expandedFolders={expandedFolders} activeCategory={activeCategory} onToggle={handleToggleFolder} onSelect={handleCategorySelect} />
                            ))}
                        </nav>
                        <div className="p-4 border-t border-slate-700 space-y-2 bg-slate-800/50">
                            <div className="flex gap-2">
                                <button onClick={() => fetchFromGitHub()} disabled={isSyncing} className="flex-1 flex items-center justify-center space-x-2 bg-slate-700 hover:bg-blue-900/30 text-slate-300 py-2 rounded-md transition-all text-sm border border-slate-600 whitespace-nowrap">
                                    <RefreshCw size={16} className={`${isSyncing?'animate-spin text-blue-400':'text-blue-500'}`} />
                                    <span>{isSyncing ? '同步中...' : '雲端更新'}</span>
                                </button>
                                {importReport && (
                                    <button onClick={() => setShowReport(true)} className="flex-1 flex items-center justify-center space-x-2 bg-slate-700 hover:bg-slate-600 text-slate-300 py-2 rounded-md text-sm border border-slate-600 whitespace-nowrap">
                                        <ClipboardList size={16} className="text-yellow-500" />
                                        <span>匯入報告</span>
                                    </button>
                                )}
                            </div>
                            <button onClick={() => setShowClearModal(true)} className="w-full flex items-center justify-center space-x-2 bg-slate-700 hover:bg-red-900/30 text-slate-300 py-2 rounded-md text-sm border border-slate-600 whitespace-nowrap">
                                <Trash2 size={16} className="text-red-500" />
                                <span>清空資料</span>
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col min-w-0 bg-slate-900">
                        <header className="h-16 bg-slate-800 border-b border-slate-700 flex items-center justify-between px-6 flex-shrink-0">
                            <div className="flex items-center space-x-4 flex-1 min-w-0">
                                <button onClick={()=>setIsSidebarOpen(!isSidebarOpen)} className="p-2 hover:bg-slate-700 rounded-md text-slate-400 transition-colors flex-shrink-0">
                                    {isSidebarOpen ? <PanelLeftClose size={20}/> : <PanelLeftOpen size={20}/>}
                                </button>
                                <button
                                    onClick={handleGoUp}
                                    disabled={activeCategory === '全部'}
                                    className={`p-2 rounded-md transition-colors mr-2 flex-shrink-0 ${activeCategory === '全部' ? 'text-slate-600 cursor-not-allowed' : 'text-slate-400 hover:bg-slate-700 hover:text-white'}`}
                                    title="返回上一層"
                                >
                                    <ArrowLeft size={20} />
                                </button>
                                <div className="text-slate-300 font-medium truncate text-sm hidden sm:block">
                                    {activeCategory === '全部' ? '所有檔案' : activeCategory.split('/').join(' / ')}
                                </div>
                            </div>
                            
                            <div className="flex items-center space-x-2 flex-shrink-0 ml-4">
                                <SearchMenu 
                                    searchQuery={searchQuery}
                                    onSearchChange={handleSearchChange}
                                    onClear={handleSearchClear}
                                />
                                <DisplaySettingsMenu 
                                    sortOption={sortOption} 
                                    setSortOption={setSortOption} 
                                    filterType={filterType} 
                                    setFilterType={setFilterType} 
                                />
                                <div className="flex bg-slate-700 p-1 rounded-md border border-slate-600">
                                    <button onClick={()=>setViewMode('list')} className={`p-1.5 rounded transition-all ${viewMode==='list'?'bg-slate-600 text-blue-400 shadow-sm':'text-slate-500 hover:text-slate-300'}`}><LayoutList size={18}/></button>
                                    <button onClick={()=>setViewMode('grid')} className={`p-1.5 rounded transition-all ${viewMode==='grid'?'bg-slate-600 text-blue-400 shadow-sm':'text-slate-500 hover:text-slate-300'}`}><LayoutGrid size={18}/></button>
                                </div>
                            </div>
                        </header>

                        <div className="flex-1 bg-slate-900">
                            <VirtualGallery 
                                items={displayItems} 
                                viewMode={viewMode}
                                onItemClick={handleItemClick}
                                onFolderClick={handleCategorySelect} 
                            />
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>