<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>雲端與本地多媒體管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        body { background-color: #0f172a; color: #f1f5f9; overflow: hidden; user-select: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef, useCallback, forwardRef, useImperativeHandle, memo } = React;

        const _cfg = [
            "aHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tLw==", 
            "dG9ueWtvYmVyL3Jlcy9yZWZzL2hlYWRzL21haW4vdmlkZW9fZGF0YS5qc29u"
        ];
        const GITHUB_JSON_URL = atob(_cfg[0]) + atob(_cfg[1]);
        const STORAGE_KEY = 'cloud_video_manager_data';
        const REPORT_KEY = 'cloud_video_manager_report';
        
        const SYNC_PASSWORD = "1234";

        const useDebounce = (value, delay) => {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => { setDebouncedValue(value); }, delay);
                return () => clearTimeout(handler);
            }, [value, delay]);
            return debouncedValue;
        };

        const useResizeObserver = (ref) => {
            const [dimensions, setDimensions] = useState({ width: 0, height: 0 });
            useEffect(() => {
                if (!ref.current) return;
                const resizeObserver = new ResizeObserver((entries) => {
                    if (!entries || entries.length === 0) return;
                    const { width, height } = entries[0].contentRect;
                    setDimensions({ width, height });
                });
                resizeObserver.observe(ref.current);
                return () => resizeObserver.disconnect();
            }, [ref]);
            return dimensions;
        };

        const fetchWithBackoff = async (url, retries = 3, delay = 1000) => {
            try {
                const response = await fetch(url, { cache: "no-store" });
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                const text = await response.text();
                const tryParse = (str) => { try { return JSON.parse(str); } catch (e) { return null; } };
                let result = tryParse(text);
                if (result) return result;
                const textNoControl = text.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F\x7F]/g, "");
                result = tryParse(textNoControl);
                if (result) return result;
                const textCleanAll = text.replace(/[\x00-\x1F\x7F]/g, "");
                result = tryParse(textCleanAll);
                if (result) return result;
                JSON.parse(text);
            } catch (error) {
                if (error.message.includes("Status: 404")) throw error;
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(url, retries - 1, delay * 2);
                }
                throw error;
            }
        };

        const safeBase64Decode = (str) => {
            try {
                return decodeURIComponent(atob(str).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            } catch (e) { return str; }
        };

        const validateAndNormalizeData = (rawData) => {
            const report = { timestamp: new Date().toLocaleString(), totalRaw: 0, success: 0, failed: 0, logs: [] };
            if (!Array.isArray(rawData)) return { validData: [], report };
            report.totalRaw = rawData.length;
            const validData = [];
            const seenIds = new Set();
            rawData.forEach((item) => {
                if (!item || typeof item !== 'object' || !item.id || seenIds.has(item.id)) { report.failed++; return; }
                seenIds.add(item.id);
                const newItem = { ...item };
                delete newItem.author;
                newItem.title = newItem.title || '未命名檔案';
                let category = '未分類';
                if (newItem.category) {
                    const decoded = safeBase64Decode(newItem.category);
                    category = decoded.replace(/\\/g, '/').trim().replace(/^\/+|\/+$/g, '') || '未分類';
                }
                newItem.category = category;
                newItem.type = ['video', 'image', 'audio', 'pdf'].includes(newItem.type) ? newItem.type : 'video';
                newItem.source = 'cloud';
                validData.push(newItem);
            });
            report.success = validData.length;
            return { validData, report };
        };

        const FixedSizeList = forwardRef(({ height, width, itemCount, itemSize, children: Row, className, style, itemData }, ref) => {
            const [scrollTop, setScrollTop] = useState(0);
            const containerRef = useRef(null);
            useImperativeHandle(ref, () => ({ scrollTo: (scrollOffset) => { if (containerRef.current) containerRef.current.scrollTop = scrollOffset; } }));
            const onScroll = (e) => setScrollTop(e.currentTarget.scrollTop);
            const totalHeight = itemCount * itemSize;
            const startIndex = Math.floor(scrollTop / itemSize);
            const buffer = 5; 
            const visibleNodeCount = Math.ceil(height / itemSize);
            const startNode = Math.max(0, startIndex - buffer);
            const endNode = Math.min(itemCount, startIndex + visibleNodeCount + buffer);
            const items = [];
            for (let i = startNode; i < endNode; i++) {
                items.push(<Row key={i} index={i} style={{ position: 'absolute', top: i * itemSize, left: 0, width: '100%', height: itemSize }} data={itemData} />);
            }
            return (
                <div ref={containerRef} className={className} style={{ ...style, width, height, overflowY: 'auto', overflowX: 'hidden', position: 'relative' }} onScroll={onScroll}>
                    <div style={{ height: totalHeight, width: '100%', position: 'relative' }}>{items}</div>
                </div>
            );
        });

        const createIcon = (paths) => ({ size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{paths}</svg>
        );

        const Icons = {
            Play: createIcon(<polygon points="5 3 19 12 5 21 5 3"></polygon>),
            Image: createIcon(<><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></>),
            Music: createIcon(<><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></>),
            FileText: createIcon(<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></>),
            Eye: createIcon(<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></>),
            Search: createIcon(<><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></>),
            Folder: createIcon(<path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 2H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path>),
            FileVideo: createIcon(<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="m10 11 5 3-5 3v-6Z"></path></>),
            X: createIcon(<><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></>),
            LayoutList: createIcon(<><rect width="7" height="7" x="3" y="3" rx="1"></rect><rect width="7" height="7" x="3" y="14" rx="1"></rect><path d="M14 4h7"></path><path d="M14 9h7"></path><path d="M14 15h7"></path><path d="M14 20h7"></path></>),
            LayoutGrid: createIcon(<><rect width="7" height="7" x="3" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="14" rx="1"></rect><rect width="7" height="7" x="3" y="14" rx="1"></rect></>),
            RefreshCw: createIcon(<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></>),
            ChevronRight: createIcon(<path d="m9 18 6-6-6-6"></path>),
            ChevronDown: createIcon(<path d="m6 9 6 6 6-6"></path>),
            FolderOpen: createIcon(<><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-3.25 7a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2"></path></>),
            CornerDownRight: createIcon(<><polyline points="15 10 20 15 15 20"></polyline><path d="M4 4v7a4 4 0 0 0 4 4h12"></path></>),
            PanelLeftClose: createIcon(<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><path d="M9 3v18"></path><path d="m16 15-3-3 3-3"></path></>),
            PanelLeftOpen: createIcon(<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><path d="M9 3v18"></path><path d="m14 15 3-3-3-3"></path></>),
            Trash2: createIcon(<><path d="M3 6h18"></path><path d="M19 6v14c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V6"></path><path d="M8 6V4c0-1.1.9-2 2-2h4c1.1 0 2 .9 2 2v2"></path><line x1="10" x2="10" y1="11" y2="17"></line><line x1="14" x2="14" y1="11" y2="17"></line></>),
            AlertCircle: createIcon(<><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></>),
            ExternalLink: createIcon(<><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></>),
            ArrowLeft: createIcon(<><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></>),
            SlidersHorizontal: createIcon(<><line x1="21" y1="4" x2="14" y2="4"></line><line x1="10" y1="4" x2="3" y2="4"></line><line x1="21" y1="12" x2="12" y2="12"></line><line x1="8" y1="12" x2="3" y2="12"></line><line x1="21" y1="20" x2="16" y2="20"></line><line x1="12" y1="20" x2="3" y2="20"></line><line x1="14" y1="2" x2="14" y2="6"></line><line x1="8" y1="10" x2="8" y2="14"></line><line x1="16" y1="18" x2="16" y2="22"></line></>),
            Check: createIcon(<polyline points="20 6 9 17 4 12"></polyline>),
            ClipboardList: createIcon(<><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></>),
            HardDrive: createIcon(<><rect width="20" height="8" x="2" y="6" rx="2"/><rect width="20" height="8" x="2" y="14" rx="2"/><line x1="6" x2="6.01" y1="10" y2="10"/><line x1="6" x2="6.01" y1="18" y2="18"/></>),
            ShieldAlert: createIcon(<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>),
            Cloud: createIcon(<path d="M17.5 19c2.5 0 4.5-2 4.5-4.5 0-2.3-1.7-4.2-3.9-4.5C17.4 6.7 14.2 4 10.5 4 7.2 4 4.4 6.1 3.3 9.1 1.4 10.1 0 12.1 0 14.5 0 17 2 19 4.5 19h13z"></path>),
            Lock: createIcon(<><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></>),
            Save: createIcon(<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>),
            Upload: createIcon(<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>),
            FileWarning: createIcon(<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><circle cx="12" cy="18" r="1"/></>),
            Link: createIcon(<><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></>),
            Edit3: createIcon(<><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></>),
        };
        const { Play, Image: ImageIcon, Music, FileText, Eye, Search, Folder, FileVideo, X, LayoutList, LayoutGrid, RefreshCw, ChevronRight, ChevronDown, FolderOpen, CornerDownRight, PanelLeftClose, PanelLeftOpen, Trash2, AlertCircle, ExternalLink, ArrowLeft, SlidersHorizontal, Check, ClipboardList, HardDrive, ShieldAlert, Cloud, Lock, Save, Upload, FileWarning, Link: LinkIcon, Edit3 } = Icons;

        const PasswordModal = ({ isOpen, onClose, onConfirm }) => {
            const [input, setInput] = useState("");
            const [error, setError] = useState(false);
            const inputRef = useRef(null);
            useEffect(() => { if (isOpen) { setInput(""); setError(false); setTimeout(() => inputRef.current?.focus(), 100); } }, [isOpen]);
            if (!isOpen) return null;
            const handleAction = () => { if (input === SYNC_PASSWORD) { onConfirm(); } else { setError(true); setInput(""); inputRef.current?.focus(); } };
            return (
                <div className="fixed inset-0 z-[130] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden mx-4">
                        <div className="p-8 flex flex-col items-center text-center">
                            <div className="w-16 h-16 rounded-full bg-blue-900/30 flex items-center justify-center mb-6 border border-blue-500/20 text-blue-400"><Lock size={32} /></div>
                            <h3 className="text-xl font-bold text-white mb-2">安全驗證</h3>
                            <p className="text-sm text-slate-400 mb-6">請輸入同步密碼以執行雲端更新</p>
                            <div className="w-full relative">
                                <input ref={inputRef} type="password" value={input} onChange={(e) => { setInput(e.target.value); setError(false); }} onKeyDown={(e) => e.key === 'Enter' && handleAction()} placeholder="輸入密碼" className={`w-full bg-slate-800 border ${error ? 'border-red-500 animate-shake' : 'border-slate-700'} rounded-xl py-3 px-4 text-center text-white outline-none focus:border-blue-500 transition-all`} />
                                {error && <p className="text-red-500 text-xs mt-2">密碼錯誤，請重新輸入</p>}
                            </div>
                        </div>
                        <div className="flex border-t border-slate-700 bg-slate-800/50">
                            <button onClick={onClose} className="flex-1 py-4 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 transition-colors border-r border-slate-700">取消</button>
                            <button onClick={handleAction} className="flex-1 py-4 text-sm font-bold text-blue-400 hover:text-blue-300 hover:bg-blue-900/20 transition-colors">確認</button>
                        </div>
                    </div>
                </div>
            );
        };

        const RenameModal = ({ isOpen, onClose, onConfirm, currentName }) => {
            const [input, setInput] = useState(currentName || "");
            const inputRef = useRef(null);
            useEffect(() => { if (isOpen) { setInput(currentName || ""); setTimeout(() => inputRef.current?.focus(), 100); } }, [isOpen, currentName]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[140] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden mx-4">
                        <div className="p-6">
                            <h3 className="text-lg font-bold text-white mb-4">重新命名資料夾</h3>
                            <input ref={inputRef} type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && onConfirm(input)} className="w-full bg-slate-800 border border-slate-700 rounded-xl py-2 px-4 text-white outline-none focus:border-blue-500 transition-all mb-4" />
                            <p className="text-xs text-slate-500">這只會更改此應用程式中的顯示名稱，不會影響您硬碟上的實際資料夾。</p>
                        </div>
                        <div className="flex border-t border-slate-700 bg-slate-800/50">
                            <button onClick={onClose} className="flex-1 py-3 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 transition-colors border-r border-slate-700">取消</button>
                            <button onClick={() => onConfirm(input)} className="flex-1 py-3 text-sm font-bold text-blue-400 hover:text-blue-300 hover:bg-blue-900/20 transition-colors">確定</button>
                        </div>
                    </div>
                </div>
            );
        };

        const LocalPermissionModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[120] bg-black/80 backdrop-blur-md flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-slate-900 border border-slate-700 rounded-2xl shadow-2xl w-full max-w-md overflow-hidden mx-4">
                        <div className="p-8 flex flex-col items-center text-center">
                            <div className="w-16 h-16 rounded-full bg-yellow-900/30 flex items-center justify-center mb-6 border border-yellow-500/20"><ShieldAlert size={32} className="text-yellow-500" /></div>
                            <h3 className="text-xl font-bold text-white mb-4">無法開啟本地資源</h3>
                            <div className="text-sm text-slate-400 space-y-4 text-left leading-relaxed">
                                <p>由於瀏覽器的安全隱私限制（Sandbox），直接從網路或本地檔案模式（file://）啟動時，會被禁用「資料夾存取」功能。</p>
                                <div className="bg-slate-800 p-4 rounded-lg border border-slate-700">
                                    <p className="font-bold text-slate-200 mb-1">解決方案：</p>
                                    <ul className="list-disc list-inside space-y-1"><li>請確保網址開頭為 <span className="text-blue-400">https://</span></li><li>或在本地啟動 Web 伺服器 (如 <span className="text-blue-400">localhost</span>)</li><li>或使用最新版的 Chrome / Edge 瀏覽器</li></ul>
                                </div>
                            </div>
                        </div>
                        <div className="p-4 bg-slate-800/50 border-t border-slate-700"><button onClick={onClose} className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl transition-all">我知道了</button></div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message, type = "danger" }) => {
            if (!isOpen) return null;
            const isDanger = type === "danger";
            return (
                <div className="fixed inset-0 z-[150] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl w-full max-w-sm mx-4 flex flex-col transform transition-all scale-100 overflow-hidden">
                        <div className="p-6 flex flex-col items-center text-center">
                            <div className={`w-12 h-12 rounded-full ${isDanger?'bg-red-900/30 border-red-500/20':'bg-blue-900/30 border-blue-500/20'} flex items-center justify-center mb-4 border`}>
                                {isDanger ? <Trash2 size={24} className="text-red-500" /> : <AlertCircle size={24} className="text-blue-500" />}
                            </div>
                            <h3 className="text-lg font-bold text-white mb-2">{title}</h3>
                            <p className="text-sm text-slate-400 leading-relaxed whitespace-pre-wrap">{message}</p>
                        </div>
                        <div className="flex border-t border-slate-700 bg-slate-800/50">
                            <button onClick={onClose} className="flex-1 py-3 text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 transition-colors border-r border-slate-700">取消</button>
                            <button onClick={onConfirm} className={`flex-1 py-3 text-sm font-bold ${isDanger?'text-red-400 hover:text-red-300 hover:bg-red-900/20':'text-blue-400 hover:text-blue-300 hover:bg-blue-900/20'} transition-colors`}>確定</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ReportModal = ({ report, onClose }) => {
            if (!report) return null;
            return (
                <div className="fixed inset-0 z-[60] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
                    <div className="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl w-full max-w-lg flex flex-col max-h-[80vh] mx-4">
                        <div className="flex items-center justify-between px-6 py-4 border-b border-slate-700 bg-slate-800 rounded-t-xl">
                            <div className="flex items-center space-x-2 text-white font-bold text-lg"><ClipboardList size={20} className="text-blue-400" /><span>匯入情況報告</span></div>
                            <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors"><X size={20} /></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">
                            <div className="grid grid-cols-3 gap-4 mb-6">
                                <div className="bg-blue-900/30 p-3 rounded-lg text-center border border-blue-800/50"><div className="text-xs text-blue-400 mb-1">總項目數</div><div className="text-xl font-bold text-blue-400">{report.totalRaw}</div></div>
                                <div className="bg-green-900/30 p-3 rounded-lg text-center border border-green-800/50"><div className="text-xs text-green-400 mb-1">成功匯入</div><div className="text-xl font-bold text-green-400">{report.success}</div></div>
                                <div className="bg-red-900/30 p-3 rounded-lg text-center border border-red-800/50"><div className="text-xs text-red-400 mb-1">失敗/忽略</div><div className="text-xl font-bold text-red-400">{report.failed}</div></div>
                            </div>
                            <div className="text-xs text-slate-500 mb-2">同步時間: {report.timestamp}</div>
                        </div>
                        <div className="p-4 border-t border-slate-700 bg-slate-800 rounded-b-xl flex justify-end"><button onClick={onClose} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm rounded-md transition-colors">關閉</button></div>
                    </div>
                </div>
            );
        };

        const getFileIcon = (type) => { switch(type) { case 'image': return ImageIcon; case 'audio': return Music; case 'pdf': return FileText; default: return Play; } };
        const getFileColor = (type) => { switch(type) { case 'image': return "text-purple-400"; case 'audio': return "text-green-400"; case 'pdf': return "text-orange-400"; default: return "text-blue-500"; } };

        const FolderTreeItem = memo(({ node, level, expandedFolders, activeCategory, onToggle, onSelect, onRemove, onConnect, onRename }) => {
            const hasChildren = Object.keys(node.children).length > 0;
            const isOpen = expandedFolders.has(node.fullPath);
            const isActive = activeCategory === node.fullPath;
            const indentSize = level * 16 + 12;
            const itemRef = useRef(null);
            const isPending = node.isPending;
            
            useEffect(() => { if (isActive && itemRef.current) setTimeout(() => itemRef.current.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100); }, [isActive]);
            
            return (
                <div className="select-none">
                    <div ref={itemRef} className={`group flex items-center py-1.5 pr-3 text-sm transition-colors cursor-pointer border-l-[3px] ${isActive ? 'bg-blue-500/10 text-blue-200 border-blue-500' : 'text-slate-400 hover:bg-slate-800 border-transparent hover:text-slate-200'}`} style={{ paddingLeft: `${indentSize}px` }} onClick={() => onSelect(node.fullPath)}>
                        <div className={`w-5 h-5 mr-1 flex items-center justify-center rounded hover:bg-white/10 shrink-0 transition-transform ${!hasChildren ? 'invisible' : ''}`} onClick={(e) => { e.stopPropagation(); onToggle(node.fullPath); }}>{isOpen ? <ChevronDown size={14} /> : <ChevronRight size={14} />}</div>
                        
                        {/* New Rename Button: Show only for Local Root level (level 0) and if onRename is provided */}
                        {onRename && level === 0 && (
                            <button
                                onClick={(e) => { e.stopPropagation(); onRename(node.name); }}
                                className="w-5 h-5 mr-1 flex items-center justify-center text-slate-500 hover:text-blue-400 hover:bg-slate-700 rounded transition-colors"
                                title="重新命名 (別名)"
                            >
                                <Edit3 size={13} />
                            </button>
                        )}
                        
                        <div className="mr-2 shrink-0">{isActive ? <FolderOpen size={18} className="text-blue-400" /> : <Folder size={18} className={`group-hover:text-slate-300 ${isPending ? 'text-slate-600' : 'text-slate-400'}`} />}</div>
                        <span className={`truncate flex-1 font-medium ${isPending ? 'text-slate-500 italic' : ''}`}>
                            {node.name}
                            {isPending && <span className="text-[10px] ml-2 px-1.5 py-0.5 rounded bg-slate-700/50 text-slate-500 not-italic">未連結</span>}
                        </span>
                        
                        <div className="flex items-center space-x-2">
                            {isPending && onConnect && (
                                <button
                                    onClick={(e) => { e.stopPropagation(); onConnect(node.name); }}
                                    className="w-5 h-5 flex items-center justify-center bg-blue-600 hover:bg-blue-500 text-white rounded transition-colors shadow-sm animate-pulse"
                                    title="點擊連結並授權資料夾"
                                >
                                    <LinkIcon size={12} strokeWidth={3} />
                                </button>
                            )}
                            {onRemove && level === 0 && (
                                <button 
                                    onClick={(e) => { e.stopPropagation(); onRemove(node.fullPath, isPending); }} 
                                    className={`w-5 h-5 flex items-center justify-center ${isPending ? 'bg-slate-700 hover:bg-red-600/80 text-slate-400 hover:text-white' : 'bg-red-600 hover:bg-red-500 text-white'} rounded transition-colors shadow-sm`}
                                    title="從清單中移除"
                                >
                                    <X size={12} strokeWidth={3} />
                                </button>
                            )}
                            {!isPending && node.totalCount > 0 && <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-slate-700/50 text-slate-500 font-bold">{node.totalCount}</span>}
                        </div>
                    </div>
                    {hasChildren && isOpen && (
                        <div>{Object.values(node.children).sort((a,b)=>a.name.localeCompare(b.name,'zh-TW')).map(child => (
                            <FolderTreeItem key={child.fullPath} node={child} level={level+1} expandedFolders={expandedFolders} activeCategory={activeCategory} onToggle={onToggle} onSelect={onSelect} onRemove={onRemove} onConnect={onConnect} onRename={onRename} />
                        ))}</div>
                    )}
                </div>
            );
        });

        // Other components (VirtualGallery, MediaThumbnail, ListThumbnail, etc.) remain mostly the same
        const VirtualGallery = memo(({ items, viewMode, onItemClick, onFolderClick }) => {
            const containerRef = useRef(null);
            const { width, height } = useResizeObserver(containerRef);
            const listRef = useRef(null);
            useEffect(() => { if (listRef.current) listRef.current.scrollTo(0); }, [items, viewMode]);
            if (items.length === 0) return <div ref={containerRef} className="h-full flex flex-col items-center justify-center text-slate-500 space-y-4"><FolderOpen size={64} className="opacity-20" /><div className="text-center text-lg font-medium opacity-50">尚無符合內容</div></div>;
            const isSmallScreen = width > 0 && width < 640; const paddingX = isSmallScreen ? 16 : 48; const gap = isSmallScreen ? 10 : 16; const availableWidth = width - paddingX; const baseMinItemWidth = isSmallScreen ? 135 : 180; let columns = Math.max(Math.floor((availableWidth + gap) / (baseMinItemWidth + gap)), 1); const itemWidth = (availableWidth - (columns - 1) * gap) / columns; 
            
            // Modified height calculation for more compact cards
            const gridRowHeight = (itemWidth * (9 / 16)) + (isSmallScreen ? 56 : 64) + gap;

            const RowList = ({ index, style, data }) => {
                const item = data[index];
                if (item.type === 'folder') return (<div style={style} className="px-2 py-1"><div onClick={() => onFolderClick(item.fullPath)} className="flex items-center h-full bg-slate-800/50 hover:bg-slate-700 border-b border-slate-700/50 cursor-pointer px-4 rounded group transition-colors"><div className="w-16 flex justify-center"><Folder size={20} className="text-yellow-500/80" /></div><div className="flex-1 ml-4 flex items-center"><CornerDownRight size={14} className="text-slate-600 mr-2" /><span className="text-slate-300 font-medium group-hover:text-blue-400">{item.name}</span></div><div className="text-slate-500 text-xs mr-4 whitespace-nowrap">資料夾 ({item.totalCount})</div></div></div>);
                const TypeIcon = getFileIcon(item.type);
                return (<div style={style} className="px-2 py-1"><div onClick={() => onItemClick(item)} className="flex items-center h-full hover:bg-slate-700/50 border-b border-slate-700/50 cursor-pointer px-4 rounded transition-colors group"><div className="w-24 shrink-0"><ListThumbnail file={item} /></div><div className="flex-1 ml-4 min-w-0"><div className="font-semibold text-slate-200 group-hover:text-blue-400 truncate flex items-center"><TypeIcon size={14} className={`mr-2 ${getFileColor(item.type)}`} />{item.title}</div><div className="text-xs text-slate-500 mt-1 flex items-center truncate"><Folder size={12} className="mr-1 flex-shrink-0"/>{item.category.split('/').pop()} {item.source === 'local' && <HardDrive size={10} className="ml-2 flex-shrink-0"/>}</div></div><div className="hidden md:block w-32 text-right text-slate-500 text-sm font-mono flex-shrink-0">{item.date}</div></div></div>);
            };
            const RowGrid = ({ index, style, data }) => {
                const { items, columns, itemWidth, gap, paddingX, height } = data; const startIndex = index * columns; const rowItems = items.slice(startIndex, startIndex + columns);
                return (<div style={{ ...style, paddingLeft: paddingX / 2, paddingRight: paddingX / 2 }} className="flex">{rowItems.map((item, i) => { const cardStyle = { width: itemWidth, height: height - gap, marginRight: i === rowItems.length - 1 ? 0 : gap }; 
                    if (item.type === 'folder') return (
                        <div key={item.fullPath} style={cardStyle} onClick={() => onFolderClick(item.fullPath)} className="bg-slate-800 border border-slate-700 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-700 hover:border-slate-600 group shrink-0 transition-all">
                            <Folder size={40} className="text-yellow-500/80 group-hover:scale-110 mb-1 transition-transform" />
                            <span className="font-medium text-slate-300 text-sm text-center truncate w-full group-hover:text-blue-400">{item.name}</span>
                            <span className="text-[10px] text-slate-600 mt-0.5">{item.totalCount} 項目</span>
                        </div>
                    ); 
                    return (
                        <div key={item.id} style={cardStyle} onClick={() => onItemClick(item)} className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden hover:border-blue-500 transition-all cursor-pointer group shrink-0 flex flex-col">
                            <MediaThumbnail file={item} />
                            <div className="p-2 flex-1 flex flex-col min-w-0 justify-between">
                                <div className="text-sm font-semibold truncate group-hover:text-blue-400" title={item.title}>{item.title}</div>
                                <div className="pt-1 flex items-center justify-between">
                                    <div className="text-[10px] text-slate-500 truncate flex-1 flex items-center">
                                        <Folder size={10} className="mr-1 flex-shrink-0"/>
                                        {item.category.split('/').pop()}
                                    </div>
                                    <div className="text-[10px] text-slate-600 font-mono ml-2 flex-shrink-0">{item.date}</div>
                                </div>
                            </div>
                        </div>
                    ); 
                })}</div>);
            };
            return (<div ref={containerRef} className="h-full w-full">{width > 0 && height > 0 && (viewMode === 'list' ? (<FixedSizeList ref={listRef} height={height} width={width} itemCount={items.length} itemSize={80} itemData={items} className="custom-scrollbar">{RowList}</FixedSizeList>) : (<FixedSizeList ref={listRef} height={height} width={width} itemCount={Math.ceil(items.length / columns)} itemSize={gridRowHeight} itemData={{ items, columns, itemWidth, gap, paddingX, height: gridRowHeight }} className="custom-scrollbar">{RowGrid}</FixedSizeList>))}</div>);
        });

        const MediaThumbnail = memo(({ file }) => {
            const [imageError, setImageError] = useState(false);
            const [localThumb, setLocalThumb] = useState(null);
            
            const isLocalMissing = file.source === 'local' && !file.fileObject;

            useEffect(() => { 
                if (file.source === 'local' && file.type === 'image' && file.fileObject) { 
                    const url = URL.createObjectURL(file.fileObject); 
                    setLocalThumb(url); 
                    return () => URL.revokeObjectURL(url); 
                } 
            }, [file]);
            
            const thumbnailUrl = file.source === 'local' ? localThumb : ((file.type === 'video' || file.type === 'image') && !imageError && file.id && file.id.length > 5 ? `https://lh3.googleusercontent.com/d/${file.id}=w320` : null);
            
            if (isLocalMissing) {
                return (
                    <div className="aspect-video bg-slate-800 relative group overflow-hidden rounded-t-xl flex items-center justify-center border-b border-slate-600/30">
                        <div className="flex flex-col items-center justify-center text-amber-500/50">
                            <FileWarning size={32} />
                            <span className="text-[10px] mt-1 font-bold">需重新掃描</span>
                        </div>
                        <div className="absolute top-2 right-2 px-1.5 py-0.5 bg-amber-900/60 backdrop-blur-sm rounded text-[10px] text-amber-100 uppercase font-bold flex items-center gap-1">
                            OFFLINE
                        </div>
                    </div>
                );
            }

            return (<div className="aspect-video bg-slate-700 relative group overflow-hidden rounded-t-xl flex items-center justify-center border-b border-slate-600/30">{thumbnailUrl ? <img src={thumbnailUrl} className="w-full h-full object-cover group-hover:scale-105 transition-transform" onError={() => setImageError(true)} loading="lazy" /> : <div className="flex flex-col items-center justify-center text-slate-500">{file.type === 'video' ? <FileVideo size={32} /> : React.createElement(getFileIcon(file.type), { size: 32 })}</div>}<div className="absolute inset-0 flex items-center justify-center bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity"><div className={`w-10 h-10 rounded-full flex items-center justify-center shadow-lg transform scale-90 group-hover:scale-100 transition-transform ${file.type === 'image' ? 'bg-purple-500' : 'bg-blue-500'}`}>{file.type === 'image' ? <Eye size={18} className="text-white" /> : <Play size={18} className="ml-1 text-white" />}</div></div><div className="absolute top-2 right-2 px-1.5 py-0.5 bg-black/60 backdrop-blur-sm rounded text-[10px] text-white uppercase font-bold flex items-center gap-1">{file.source === 'local' && <HardDrive size={10} />}{file.type || 'VIDEO'}</div></div>);
        });

        const ListThumbnail = memo(({ file }) => {
            const [imageError, setImageError] = useState(false);
            const [localThumb, setLocalThumb] = useState(null);
            
            const isLocalMissing = file.source === 'local' && !file.fileObject;

            useEffect(() => { if (file.source === 'local' && file.type === 'image' && file.fileObject) { const url = URL.createObjectURL(file.fileObject); setLocalThumb(url); return () => URL.revokeObjectURL(url); } }, [file]);
            
            if (isLocalMissing) {
                return <div className="w-24 h-14 bg-slate-800 rounded overflow-hidden flex-shrink-0 border border-amber-900/50 flex items-center justify-center relative"><FileWarning size={20} className="text-amber-500/50" /></div>;
            }

            const thumbnailUrl = file.source === 'local' ? localThumb : ((file.type === 'video' || file.type === 'image') && !imageError ? `https://lh3.googleusercontent.com/d/${file.id}=w320` : null);
            return (<div className="w-24 h-14 bg-slate-700 rounded overflow-hidden flex-shrink-0 border border-slate-600 flex items-center justify-center relative">{thumbnailUrl ? <img src={thumbnailUrl} className="w-full h-full object-cover" onError={() => setImageError(true)} loading="lazy" /> : React.createElement(getFileIcon(file.type), { size: 20, className: "text-slate-500" })}<div className={`absolute bottom-0 right-0 w-3 h-3 ${file.type === 'image' ? 'bg-purple-500' : 'bg-blue-500'} rounded-tl`}></div></div>);
        });

        const SearchMenu = memo(({ searchQuery, onSearchChange, onClear }) => {
            const [isOpen, setIsOpen] = useState(false); const menuRef = useRef(null); const inputRef = useRef(null);
            useEffect(() => { const h = (e) => { if (menuRef.current && !menuRef.current.contains(e.target)) setIsOpen(false); }; document.addEventListener('mousedown', h); return () => document.removeEventListener('mousedown', h); }, []);
            useEffect(() => { if (isOpen && inputRef.current) setTimeout(() => inputRef.current.focus(), 100); }, [isOpen]);
            return (<div className="relative" ref={menuRef}><button onClick={() => setIsOpen(!isOpen)} className={`flex items-center justify-center p-2 rounded-md transition-colors ${searchQuery.trim() !== '' || isOpen ? 'bg-slate-700 text-blue-400 border-slate-600' : 'text-slate-400 hover:bg-slate-700 border-transparent'}`} title="搜尋檔案"><Search size={20} /></button>{isOpen && (<div className="absolute right-0 top-full mt-2 w-72 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-50 p-3 animate-fade-in origin-top-right"><div className="relative"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={16} /><input ref={inputRef} type="text" placeholder="輸入關鍵字..." className="w-full pl-9 pr-8 py-2 bg-slate-900 rounded-md text-sm outline-none border border-slate-700 focus:border-blue-500 text-slate-200 placeholder-slate-500" value={searchQuery} onChange={onSearchChange} />{searchQuery.trim() !== '' && <button onClick={() => { onClear(); inputRef.current.focus(); }} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-300"><X size={14} /></button>}</div></div>)}</div>);
        });

        const DisplaySettingsMenu = memo(({ sortOption, setSortOption, filterType, setFilterType }) => {
            const [isOpen, setIsOpen] = useState(false); const menuRef = useRef(null);
            useEffect(() => { const h = (e) => { if (menuRef.current && !menuRef.current.contains(e.target)) setIsOpen(false); }; document.addEventListener('mousedown', h); return () => document.removeEventListener('mousedown', h); }, []);
            return (<div className="relative" ref={menuRef}><button onClick={() => setIsOpen(!isOpen)} className={`flex items-center space-x-1 px-2 py-2 rounded-md transition-colors ${isOpen ? 'bg-slate-700 text-white border-slate-600' : 'text-slate-400 hover:bg-slate-700 border-transparent'}`} title="顯示設定"><SlidersHorizontal size={20} /><ChevronDown size={12} className={`transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`} /></button>{isOpen && (<div className="absolute right-0 top-full mt-2 w-56 bg-slate-800 border border-slate-700 rounded-lg shadow-xl z-50 py-2 animate-fade-in origin-top-right"><div className="px-3 py-1.5 text-xs font-bold text-slate-500 uppercase tracking-wider">排序方式</div>{[{v:'date_desc', l:'日期 (新→舊)'}, {v:'date_asc', l:'日期 (舊→新)'}, {v:'name_asc', l:'名稱 (A→Z)'}, {v:'name_desc', l:'名稱 (Z→A)'}].map(opt => (<button key={opt.v} onClick={() => { setSortOption(opt.v); setIsOpen(false); }} className="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 flex items-center justify-between">{opt.l}{sortOption === opt.v && <Check size={14} className="text-blue-400" />}</button>))}<div className="my-1 border-t border-slate-700"></div><div className="px-3 py-1.5 text-xs font-bold text-slate-500 uppercase tracking-wider">過濾類型</div>{[{v:'all', l:'全部類型'}, {v:'video', l:'僅影片'}, {v:'image', l:'僅圖片'}, {v:'audio', l:'僅音訊'}, {v:'pdf', l:'僅文件'}].map(opt => (<button key={opt.v} onClick={() => { setFilterType(opt.v); setIsOpen(false); }} className="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-slate-700 flex items-center justify-between">{opt.l}{filterType === opt.v && <Check size={14} className="text-blue-400" />}</button>))}</div>)}</div>);
        });

        const UniversalViewer = ({ file, onClose }) => {
            const [localUrl, setLocalUrl] = useState(null);
            
            const isLocalMissing = file.source === 'local' && !file.fileObject;

            useEffect(() => { 
                if (file && file.source === 'local' && file.fileObject) { 
                    const url = URL.createObjectURL(file.fileObject); 
                    setLocalUrl(url); 
                    return () => URL.revokeObjectURL(url); 
                } 
            }, [file]);

            if (!file) return null;
            const isLocal = file.source === 'local';
            const previewUrl = isLocal ? localUrl : `https://drive.google.com/file/d/${file.id}/preview`;
            
            const renderLocalContent = () => { 
                if (isLocalMissing) {
                    return (
                        <div className="flex flex-col items-center justify-center h-full text-slate-400 space-y-4">
                            <FileWarning size={64} className="text-amber-500" />
                            <div className="text-center">
                                <h3 className="text-xl font-bold text-white mb-2">檔案無法讀取</h3>
                                <p className="text-sm">此為匯入的索引紀錄，瀏覽器無法直接存取硬碟檔案。</p>
                                <p className="text-sm mt-1 text-blue-400">請從左側選單重新點選「本地資源」按鈕來授權資料夾。</p>
                            </div>
                        </div>
                    );
                }
                if (!localUrl) return <div className="text-slate-500">載入中...</div>; 
                switch (file.type) { 
                    case 'image': return <img src={localUrl} className="max-w-full max-h-full object-contain" />; 
                    case 'audio': return <audio controls autoPlay src={localUrl} className="w-full max-w-md" />; 
                    case 'pdf': return <iframe src={localUrl} className="w-full h-full border-0 bg-white" />; 
                    default: return <video controls autoPlay src={localUrl} className="w-full h-full object-contain" />; 
                } 
            };
            
            return (<div className="fixed inset-0 z-[100] bg-black/95 flex flex-col animate-fade-in"><div className="flex items-center justify-between px-4 py-3 bg-slate-800/80 backdrop-blur-sm border-b border-slate-700/50 flex-shrink-0 z-10"><div className="text-slate-200 font-medium truncate flex-1 mr-4">{file.title} {isLocal && <span className="text-[10px] bg-slate-600 px-1 rounded ml-1">LOCAL</span>}</div><div className="flex items-center space-x-3">{!isLocal && <button onClick={() => window.open(previewUrl, '_blank', 'width=720,height=480,resizable,scrollbars')} className="flex items-center space-x-1.5 px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white rounded-md text-sm transition-colors shadow-sm"><ExternalLink size={16} /><span className="hidden sm:inline">新視窗開啟</span></button>}<button onClick={onClose} className="p-2 hover:bg-slate-700 rounded-full text-slate-400 hover:text-white transition-colors"><X size={24} /></button></div></div><div className="flex-1 overflow-hidden relative flex items-center justify-center bg-black p-0">{isLocal ? renderLocalContent() : <iframe src={previewUrl} className="w-full h-full border-0" allow="autoplay; fullscreen" title={file.title} />}</div></div>);
        };

        function App() {
            const [videoData, setVideoData] = useState([]);
            const [localFiles, setLocalFiles] = useState([]); 
            const [localHandles, setLocalHandles] = useState({});
            const [isSyncing, setIsSyncing] = useState(false);
            const [statusMsg, setStatusMsg] = useState(null);
            const [activeCategory, setActiveCategory] = useState('全部');
            const [searchQuery, setSearchQuery] = useState('');
            const [viewMode, setViewMode] = useState('list');
            const [sortOption, setSortOption] = useState('date_desc');
            const [filterType, setFilterType] = useState('all');
            const [viewingFile, setViewingFile] = useState(null);
            const [expandedFolders, setExpandedFolders] = useState(new Set());
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [importReport, setImportReport] = useState(null);
            const [showReport, setShowReport] = useState(false);
            const [showClearModal, setShowClearModal] = useState(false);
            const [showLocalWarn, setShowLocalWarn] = useState(false);
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [isCloudExpanded, setIsCloudExpanded] = useState(true);
            const [isLocalExpanded, setIsLocalExpanded] = useState(true);
            const [folderToRemove, setFolderToRemove] = useState(null);
            const [folderToRename, setFolderToRename] = useState(null);
            
            const [pendingLocalRoots, setPendingLocalRoots] = useState(new Set());
            
            const fileInputRef = useRef(null);

            const debouncedSearchQuery = useDebounce(searchQuery, 300);

            const handleCategorySelect = useCallback((path) => {
                setActiveCategory(path);
                if (window.innerWidth < 768) setIsSidebarOpen(false);
                if (path === '全部') return;
                setExpandedFolders(prev => { 
                    const next = new Set(prev); 
                    const parts = path.split('/'); 
                    let current = ''; 
                    parts.forEach(p => { current = current ? `${current}/${p}` : p; next.add(current); }); 
                    return next; 
                });
            }, []);

            const handleGoUp = useCallback(() => { 
                if (activeCategory === '全部') return; 
                const parts = activeCategory.split('/'); 
                if (parts.length <= 1) handleCategorySelect('全部'); 
                else { parts.pop(); handleCategorySelect(parts.join('/')); } 
            }, [activeCategory, handleCategorySelect]);

            const handleToggleFolder = useCallback((path) => { 
                setExpandedFolders(prev => { const next = new Set(prev); next.has(path) ? next.delete(path) : next.add(path); return next; }); 
            }, []);

            useEffect(() => { if (statusMsg) { const timer = setTimeout(() => { setStatusMsg(null); }, 5000); return () => clearTimeout(timer); } }, [statusMsg]);

            useEffect(() => {
                const saved = sessionStorage.getItem(STORAGE_KEY);
                const savedReport = sessionStorage.getItem(REPORT_KEY);
                if (savedReport) { try { setImportReport(JSON.parse(savedReport)); } catch(e) {} }
                if (saved) { 
                    try { 
                        const parsed = JSON.parse(saved); 
                        setVideoData(parsed); 
                        if (parsed.length === 0) setShowPasswordModal(true); 
                    } catch(e) { setShowPasswordModal(true); } 
                } else { setShowPasswordModal(true); }
            }, []);

            useEffect(() => { sessionStorage.setItem(STORAGE_KEY, JSON.stringify(videoData)); }, [videoData]);
            useEffect(() => { if(importReport) sessionStorage.setItem(REPORT_KEY, JSON.stringify(importReport)); }, [importReport]);

            const fetchFromGitHub = async () => {
                if (isSyncing) return;
                setIsSyncing(true);
                setShowPasswordModal(false); 
                try {
                    const baseUrl = GITHUB_JSON_URL.substring(0, GITHUB_JSON_URL.lastIndexOf('/') + 1);
                    const indexUrl = `${baseUrl}index.json`;
                    let accumulatedData = []; let usedIndex = false;
                    try { 
                        const indexList = await fetchWithBackoff(indexUrl, 1); 
                        if (Array.isArray(indexList)) { 
                            usedIndex = true; 
                            for (const filename of indexList) { 
                                const data = await fetchWithBackoff(`${baseUrl}${filename}`); 
                                if (Array.isArray(data)) accumulatedData = [...accumulatedData, ...data]; 
                            } 
                        } 
                    } catch (e) {}
                    if (!usedIndex) { 
                        let partIndex = 1; 
                        while (true) { 
                            try { 
                                const data = await fetchWithBackoff(`${baseUrl}video_data_part${partIndex}.json`, partIndex === 1 ? 3 : 0); 
                                if (Array.isArray(data)) { accumulatedData = [...accumulatedData, ...data]; partIndex++; } else break; 
                            } catch (e) { break; } 
                        } 
                    }
                    const { validData, report } = validateAndNormalizeData(accumulatedData);
                    setVideoData(validData);
                    setImportReport(report);
                    setShowReport(true);
                    setActiveCategory('全部');
                    // ★ 修正: 資料加載後全部收合
                    setExpandedFolders(new Set());
                    setStatusMsg({ type: 'success', text: `同步完成！載入 ${report.success} 筆雲端資料。` });
                } catch (err) { setStatusMsg({ type: 'error', text: `同步失敗：${err.message}` }); } finally { setIsSyncing(false); }
            };

            const scanDirectory = async (dirHandle, rootAlias = null) => {
                const files = [];
                const statusReport = { total: 0, added: 0 };
                // 如果提供了 rootAlias，則使用別名作為根目錄名稱，否則使用資料夾原始名稱
                const rootName = rootAlias || dirHandle.name;

                const scan = async (handle, path = "") => {
                    // 如果是遞迴的第一層(path為空)，且有別名，則使用別名
                    // 注意：這裡的邏輯是建立分類路徑。第一層的名稱決定了「本地資源/XXX」的 XXX
                    
                    const currentFolderName = (path === "" && rootAlias) ? rootAlias : handle.name;
                    const currentPath = path ? `${path}/${handle.name}` : currentFolderName;

                    for await (const entry of handle.values()) {
                        if (entry.kind === 'directory') { await scan(entry, currentPath); } 
                        else {
                            statusReport.total++; const file = await entry.getFile(); const mime = file.type; let type = null;
                            if (mime.includes('video')) type = 'video'; else if (mime.includes('image')) type = 'image'; else if (mime.includes('audio')) type = 'audio'; else if (mime.includes('pdf') || file.name.endsWith('.pdf')) type = 'pdf';
                            if (type) { 
                                files.push({ 
                                    id: `local-${crypto.randomUUID()}`, 
                                    title: file.name, 
                                    type: type, 
                                    date: new Date(file.lastModified).toISOString().split('T')[0], 
                                    category: `本地資源/${currentPath}`, 
                                    source: 'local', 
                                    fileObject: file 
                                }); 
                                statusReport.added++; 
                            }
                        }
                    }
                };
                await scan(dirHandle);
                return { files, count: statusReport.added };
            };

            const handleLocalPicker = async () => {
                if (!window.showDirectoryPicker) { setShowLocalWarn(true); return; }
                try {
                    const dirHandle = await window.showDirectoryPicker();
                    setIsSyncing(true);
                    const { files, count } = await scanDirectory(dirHandle);
                    
                    setLocalHandles(prev => ({ ...prev, [dirHandle.name]: dirHandle }));
                    setLocalFiles(prev => [...prev, ...files]);
                    setActiveCategory('全部');
                    setExpandedFolders(new Set());
                    setStatusMsg({ type: 'success', text: `本地掃描完成！新增 ${count} 個檔案。` });
                } catch (err) { if (err.name !== 'AbortError') setStatusMsg({ type: 'error', text: `讀取失敗: ${err.message}` }); } finally { setIsSyncing(false); }
            };

            const handleConnectLocalFolder = async (pendingName) => {
                if (!window.showDirectoryPicker) { setShowLocalWarn(true); return; }
                try {
                    const dirHandle = await window.showDirectoryPicker();
                    
                    if (dirHandle.name !== pendingName) {
                        const proceed = window.confirm(`警告：您選取的資料夾名稱 (${dirHandle.name}) 與預期名稱 (${pendingName}) 不符。\n\n這將使用 "${pendingName}" 作為此資料夾在系統中的別名。\n\n是否繼續？`);
                        if (!proceed) return;
                    }

                    setIsSyncing(true);
                    // 使用 pendingName 作為 rootAlias 進行掃描
                    const { files, count } = await scanDirectory(dirHandle, pendingName);
                    
                    // 使用 pendingName 作為 Key 儲存 Handle
                    setLocalHandles(prev => ({ ...prev, [pendingName]: dirHandle }));
                    
                    setLocalFiles(prev => [...prev, ...files]);
                    setPendingLocalRoots(prev => {
                         const next = new Set(prev);
                         next.delete(pendingName);
                         return next;
                    });
                    
                    setStatusMsg({ type: 'success', text: `已成功連結並掃描 "${pendingName}" (${count} 個檔案)` });

                } catch (err) { 
                    if (err.name !== 'AbortError') setStatusMsg({ type: 'error', text: `讀取失敗: ${err.message}` }); 
                } finally { setIsSyncing(false); }
            };

            const handleClearConfirm = useCallback(() => { 
                setVideoData([]); setLocalFiles([]); setPendingLocalRoots(new Set()); setLocalHandles({}); sessionStorage.setItem(STORAGE_KEY, JSON.stringify([])); 
                setShowClearModal(false); setStatusMsg({ type: 'success', text: '所有資料已清空。' }); 
                setActiveCategory('全部'); setExpandedFolders(new Set());
            }, []);

            const handleRemoveLocalFolder = useCallback((folderPath, isPending) => {
                if (isPending) {
                     const name = folderPath.replace('本地資源/', '');
                     setPendingLocalRoots(prev => { const next = new Set(prev); next.delete(name); return next; });
                     setStatusMsg({ type: 'success', text: `已移除待連結項目 "${name}"` });
                } else {
                    setFolderToRemove(folderPath);
                }
            }, []);
            
            const handleRenameLocalFolder = useCallback((oldName) => {
                setFolderToRename(oldName);
            }, []);

            const confirmRename = useCallback((newName) => {
                if (!newName || !newName.trim() || newName === folderToRename) {
                    setFolderToRename(null);
                    return;
                }
                
                const trimmedName = newName.trim();
                
                // 檢查名稱衝突
                // 1. 檢查是否與現有 handles 衝突
                if (localHandles[trimmedName]) {
                    alert(`名稱 "${trimmedName}" 已存在，請使用其他名稱。`);
                    return;
                }
                // 2. 檢查是否與 pending roots 衝突
                if (pendingLocalRoots.has(trimmedName)) {
                    alert(`名稱 "${trimmedName}" 已在待連結清單中，請使用其他名稱。`);
                    return;
                }

                // 開始更名流程
                // 1. 更新 localHandles 的 Key
                setLocalHandles(prev => {
                    const next = { ...prev };
                    if (next[folderToRename]) {
                        next[trimmedName] = next[folderToRename];
                        delete next[folderToRename];
                    }
                    return next;
                });

                // 2. 更新 pendingLocalRoots
                setPendingLocalRoots(prev => {
                    const next = new Set(prev);
                    if (next.has(folderToRename)) {
                        next.delete(folderToRename);
                        next.add(trimmedName);
                    }
                    return next;
                });

                // 3. 更新所有相關檔案的 category 路徑
                setLocalFiles(prev => prev.map(f => {
                    const oldPrefix = `本地資源/${folderToRename}`;
                    if (f.category.startsWith(oldPrefix)) {
                        // 替換路徑前綴
                        const newCategory = f.category.replace(oldPrefix, `本地資源/${trimmedName}`);
                        return { ...f, category: newCategory };
                    }
                    return f;
                }));
                
                // 4. 如果當前選中的分類剛好是被更名的資料夾，更新 activeCategory
                if (activeCategory.startsWith(`本地資源/${folderToRename}`)) {
                    setActiveCategory(prev => prev.replace(`本地資源/${folderToRename}`, `本地資源/${trimmedName}`));
                }

                setStatusMsg({ type: 'success', text: `已將 "${folderToRename}" 重新命名為 "${trimmedName}"` });
                setFolderToRename(null);
            }, [folderToRename, localHandles, pendingLocalRoots, activeCategory]);

            const confirmRemoveLocalFolder = useCallback(() => {
                if (!folderToRemove) return;
                
                const rootName = folderToRemove.replace('本地資源/', '').split('/')[0];
                setLocalHandles(prev => {
                    const next = { ...prev };
                    delete next[rootName];
                    return next;
                });
                
                 setLocalFiles(prev => prev.filter(file => !file.category.startsWith(folderToRemove)));
                setStatusMsg({ type: 'success', text: `路徑資源已從清單移除。` });
                setFolderToRemove(null);
                if (activeCategory.startsWith(folderToRemove)) setActiveCategory('全部');
            }, [folderToRemove, activeCategory]);
            
            const handleSaveLocalIndex = async (e) => {
                e.stopPropagation();
                if (localFiles.length === 0) {
                    setStatusMsg({ type: 'error', text: '目前沒有本地資源可儲存。' });
                    return;
                }
                
                const roots = [...new Set(localFiles.map(f => {
                    const parts = f.category.split('/');
                    return parts.length > 1 ? parts[1] : null;
                }))].filter(Boolean);
                
                if (roots.length === 0) {
                    setStatusMsg({ type: 'error', text: '找不到有效的資料夾結構。' });
                    return;
                }

                const jsonString = JSON.stringify(roots, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const defaultName = `local_roots_backup_${new Date().toISOString().split('T')[0]}.json`;

                try {
                    if (window.showSaveFilePicker) {
                        const handle = await window.showSaveFilePicker({
                            suggestedName: defaultName,
                            types: [{ description: 'JSON Files', accept: { 'application/json': ['.json'] } }],
                        });
                        const writable = await handle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                        setStatusMsg({ type: 'success', text: `已儲存 ${roots.length} 個資料夾路徑紀錄。` });
                    } else {
                        throw new Error("Fallback to download");
                    }
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a'); a.href = url; a.download = defaultName; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                        if (err.message === "Fallback to download") setStatusMsg({ type: 'success', text: '索引檔案已下載。' });
                    }
                }
            };

            const handleLoadLocalIndex = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const loadedData = JSON.parse(event.target.result);
                        if (!Array.isArray(loadedData) || loadedData.some(item => typeof item !== 'string')) {
                            throw new Error("格式錯誤：檔案必須是資料夾名稱的清單");
                        }
                        
                        setPendingLocalRoots(prev => {
                            const next = new Set(prev);
                            loadedData.forEach(name => next.add(name));
                            return next;
                        });
                        
                        setIsLocalExpanded(true); 
                        setStatusMsg({ type: 'success', text: `已載入 ${loadedData.length} 個待連結資料夾，請在左側選單點擊連結圖示進行授權。` });
                        
                    } catch (err) {
                        setStatusMsg({ type: 'error', text: '讀取失敗：檔案格式不正確。' });
                    }
                    e.target.value = ''; 
                };
                reader.readAsText(file);
            };

            const handleRefreshLocalFiles = async (e) => {
                e.stopPropagation();
                const entries = Object.entries(localHandles);
                if (entries.length === 0) {
                    setStatusMsg({ type: 'error', text: '沒有可重新整理的活躍連線。請先連結資料夾。' });
                    return;
                }
                
                setIsSyncing(true);
                try {
                    let totalAdded = 0;
                    const newFilesAccumulator = [];
                    const refreshedRoots = new Set();

                    for (const [keyName, handle] of entries) {
                        try {
                            // 重新掃描時，傳入 Key (別名) 作為 rootAlias
                            const { files, count } = await scanDirectory(handle, keyName);
                            newFilesAccumulator.push(...files);
                            totalAdded += count;
                            refreshedRoots.add(keyName);
                        } catch (err) {
                            console.error(`Failed to refresh ${keyName}:`, err);
                        }
                    }
                    
                    setLocalFiles(prev => {
                        const others = prev.filter(f => {
                            const root = f.category.split('/')[1]; 
                            return !refreshedRoots.has(root);
                        });
                        return [...others, ...newFilesAccumulator];
                    });
                    
                    setStatusMsg({ type: 'success', text: `已重新掃描 ${refreshedRoots.size} 個資料夾，共 ${totalAdded} 個檔案。` });
                } catch (err) {
                    setStatusMsg({ type: 'error', text: `重新整理失敗: ${err.message}` });
                } finally {
                    setIsSyncing(false);
                }
            };

            const combinedData = useMemo(() => [...videoData, ...localFiles], [videoData, localFiles]);

            const cloudFolderTree = useMemo(() => {
                const tree = {}; videoData.forEach(v => { const parts = (v.category || '未分類').split('/'); let curr = tree, path = ""; parts.forEach(p => { path = path ? `${path}/${p}` : p; if (!curr[p]) curr[p] = { name: p, fullPath: path, totalCount: 0, children: {} }; curr[p].totalCount++; curr = curr[p].children; }); }); return tree;
            }, [videoData]);

            const localFolderTree = useMemo(() => {
                const tree = {}; 
                localFiles.forEach(v => { 
                    const parts = (v.category || '未分類').split('/'); 
                    let curr = tree; 
                    let path = ""; 
                    parts.forEach((p, index) => { 
                        path = path ? `${path}/${p}` : p; 
                        if (index === 0 && p === '本地資源') return;
                        if (!curr[p]) curr[p] = { name: p, fullPath: path, totalCount: 0, children: {} }; 
                        curr[p].totalCount++; 
                        curr = curr[p].children; 
                    }); 
                }); 
                
                pendingLocalRoots.forEach(rootName => {
                    if (!tree[rootName]) {
                        tree[rootName] = {
                            name: rootName,
                            fullPath: `本地資源/${rootName}`,
                            totalCount: 0,
                            children: {},
                            isPending: true
                        };
                    }
                });
                
                return tree;
            }, [localFiles, pendingLocalRoots]);

            const displayItems = useMemo(() => {
                let folders = []; const isSearching = debouncedSearchQuery !== '';
                if (!isSearching) {
                    if (activeCategory === '全部') { folders = [...Object.values(cloudFolderTree), ...Object.values(localFolderTree)]; } 
                    else { 
                        const isLocalPath = activeCategory.startsWith('本地資源'); 
                        const targetTree = isLocalPath ? localFolderTree : cloudFolderTree; 
                        const parts = activeCategory.split('/'); 
                        const traverseParts = (isLocalPath && parts[0] === '本地資源') ? parts.slice(1) : parts;
                        
                        let targetNode = targetTree; 
                        for (const p of traverseParts) { 
                            if (targetNode[p]) targetNode = targetNode[p].children; 
                            else break; 
                        } 
                        folders = Object.values(targetNode); 
                    }
                    folders.sort((a, b) => a.name.localeCompare(b.name, 'zh-TW'));
                }
                const filteredItems = combinedData.filter(v => {
                    const matchCat = activeCategory === '全部' || (v.category || '未分類').startsWith(activeCategory);
                    const matchSearch = v.title.toLowerCase().includes(debouncedSearchQuery.toLowerCase());
                    const matchType = filterType === 'all' || v.type === filterType;
                    if (activeCategory !== '全部' && !isSearching) return (v.category || '未分類') === activeCategory && matchType;
                    return matchCat && matchSearch && matchType;
                });
                filteredItems.sort((a,b) => { if (sortOption === 'date_desc') return new Date(b.date) - new Date(a.date); if (sortOption === 'date_asc') return new Date(a.date) - new Date(b.date); return sortOption === 'name_asc' ? a.title.localeCompare(b.title,'zh-TW') : b.title.localeCompare(a.title,'zh-TW'); });
                return [...folders.map(f => ({ ...f, type: 'folder' })), ...filteredItems];
            }, [combinedData, cloudFolderTree, localFolderTree, activeCategory, debouncedSearchQuery, sortOption, filterType]);

            return (
                <div className="flex h-screen overflow-hidden relative">
                    <input type="file" ref={fileInputRef} onChange={handleLoadLocalIndex} className="hidden" accept=".json" />
                    
                    {showReport && <ReportModal report={importReport} onClose={() => setShowReport(false)} />}
                    {showClearModal && <ConfirmModal isOpen={showClearModal} onClose={() => setShowClearModal(false)} onConfirm={handleClearConfirm} title="確定清空所有資料？" message="此動作將會移除目前清單中的所有項目。確定要繼續嗎？" />}
                    {showLocalWarn && <LocalPermissionModal isOpen={showLocalWarn} onClose={() => setShowLocalWarn(false)} />}
                    {showPasswordModal && <PasswordModal isOpen={showPasswordModal} onClose={() => setShowPasswordModal(false)} onConfirm={fetchFromGitHub} />}
                    
                    {folderToRename && <RenameModal isOpen={!!folderToRename} currentName={folderToRename} onClose={() => setFolderToRename(null)} onConfirm={confirmRename} />}
                    
                    {viewingFile && <UniversalViewer file={viewingFile} onClose={() => setViewingFile(null)} />}
                    {folderToRemove && <ConfirmModal isOpen={!!folderToRemove} onClose={() => setFolderToRemove(null)} onConfirm={confirmRemoveLocalFolder} title="移除本地目錄" message={`您確定要從管理清單中移除此資料夾嗎？\n這不會刪除您電腦上的實體檔案。\n\n路徑：\n${folderToRemove}`} />}

                    {statusMsg && (
                        <div className="fixed top-6 left-0 right-0 z-[110] flex justify-center px-4 pointer-events-none animate-fade-in">
                            <div className={`pointer-events-auto px-5 py-3 rounded-2xl shadow-2xl flex items-center gap-3 border ${statusMsg.type === 'success' ? 'bg-green-900/95 border-green-500/50 text-green-100' : 'bg-red-900/95 border-red-500/50 text-red-100'} backdrop-blur-md`}>
                                <AlertCircle size={20} /><span className="text-sm font-medium">{statusMsg.text}</span>
                                <button onClick={() => setStatusMsg(null)} className="hover:opacity-70"><X size={16}/></button>
                            </div>
                        </div>
                    )}

                    {isSidebarOpen && <div className="fixed inset-0 bg-black/60 z-40 md:hidden backdrop-blur-sm" onClick={() => setIsSidebarOpen(false)} />}

                    <aside className={`bg-slate-800 border-r border-slate-700 flex flex-col transition-all duration-300 ease-in-out z-50 fixed inset-y-0 left-0 h-full md:relative ${isSidebarOpen ? 'translate-x-0 w-72 shadow-2xl md:shadow-none' : '-translate-x-full w-72 md:w-0 md:translate-x-0 md:opacity-0 md:overflow-hidden'}`}>
                        <div className="p-6 border-b border-slate-700 font-bold text-lg flex items-center justify-between flex-shrink-0">
                            <div className="flex items-center space-x-2 text-blue-500"><Play size={24} fill="currentColor" /><span className="whitespace-nowrap font-bold text-white">多媒體中心</span></div>
                            <button onClick={() => setIsSidebarOpen(false)} className="md:hidden text-slate-400 hover:text-white"><X size={20} /></button>
                        </div>
                        <nav className="flex-1 overflow-y-auto p-3 custom-scrollbar space-y-6">
                            <button onClick={()=>handleCategorySelect('全部')} className={`w-full flex items-center space-x-2 px-3 py-2 rounded-md ${activeCategory==='全部' ? 'bg-blue-600 text-white font-bold' : 'text-slate-400 hover:bg-slate-700 font-bold'} transition-all`}><LayoutGrid size={18}/> <span>所有檔案 ({combinedData.length})</span></button>
                            
                            <div className="space-y-1">
                                <button onClick={() => setIsCloudExpanded(!isCloudExpanded)} className="w-full flex items-center justify-between px-3 py-2 group hover:bg-slate-700/50 rounded-lg">
                                    <div className="flex items-center gap-3 font-bold text-slate-200"><Cloud size={18} className="text-blue-400" /><span>雲端資源</span></div>
                                    <div className="text-slate-500">{isCloudExpanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}</div>
                                </button>
                                {isCloudExpanded && (
                                    <div className="animate-fade-in">{Object.values(cloudFolderTree).length === 0 ? <div className="px-3 py-2 text-xs text-slate-600 italic">尚未同步</div> : Object.values(cloudFolderTree).sort((a,b)=>a.name.localeCompare(b.name,'zh-TW')).map(node => (
                                        <FolderTreeItem key={node.fullPath} node={node} level={0} expandedFolders={expandedFolders} activeCategory={activeCategory} onToggle={handleToggleFolder} onSelect={handleCategorySelect} />
                                    ))}</div>
                                )}
                            </div>

                            <div className="space-y-1">
                                <div className="w-full flex items-center justify-between px-3 py-2 group hover:bg-slate-700/50 rounded-lg">
                                    <div className="flex items-center gap-3 font-bold text-slate-200 cursor-pointer flex-1" onClick={() => setIsLocalExpanded(!isLocalExpanded)}>
                                        <HardDrive size={18} className="text-purple-400" /><span>本地資源</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <button 
                                            onClick={handleRefreshLocalFiles}
                                            className="p-1.5 text-slate-400 hover:text-orange-400 hover:bg-slate-600 rounded transition-colors"
                                            title="重新整理所有已連結的資料夾"
                                        >
                                            <RefreshCw size={14} className={isSyncing ? 'animate-spin' : ''} />
                                        </button>
                                        <button 
                                            onClick={handleSaveLocalIndex} 
                                            className="p-1.5 text-slate-400 hover:text-blue-400 hover:bg-slate-600 rounded transition-colors"
                                            title="儲存本地資源路徑紀錄 (JSON)"
                                        >
                                            <Save size={14} />
                                        </button>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); fileInputRef.current?.click(); }} 
                                            className="p-1.5 text-slate-400 hover:text-green-400 hover:bg-slate-600 rounded transition-colors"
                                            title="讀取本地資源路徑紀錄 (JSON)"
                                        >
                                            <Upload size={14} />
                                        </button>
                                        <div onClick={() => setIsLocalExpanded(!isLocalExpanded)} className="text-slate-500 cursor-pointer p-1">
                                            {isLocalExpanded ? <ChevronDown size={14} /> : <ChevronRight size={14} />}
                                        </div>
                                    </div>
                                </div>
                                {isLocalExpanded && (
                                    <div className="animate-fade-in">{Object.values(localFolderTree).length === 0 ? <div className="px-3 py-2 text-xs text-slate-600 italic">尚未載入</div> : Object.values(localFolderTree).sort((a,b)=>a.name.localeCompare(b.name,'zh-TW')).map(node => (
                                        <FolderTreeItem key={node.fullPath} node={node} level={0} expandedFolders={expandedFolders} activeCategory={activeCategory} onToggle={handleToggleFolder} onSelect={handleCategorySelect} onRemove={handleRemoveLocalFolder} onConnect={handleConnectLocalFolder} onRename={handleRenameLocalFolder} />
                                    ))}</div>
                                )}
                            </div>
                        </nav>
                        <div className="p-4 border-t border-slate-700 space-y-2 bg-slate-800/50 flex-shrink-0">
                            <div className="flex gap-2">
                                <button onClick={() => setShowPasswordModal(true)} disabled={isSyncing} className="flex-1 flex items-center justify-center space-x-2 bg-slate-700 hover:bg-blue-900/30 text-white py-2 rounded-md border border-slate-600 transition-all text-xs font-bold"><RefreshCw size={14} className={isSyncing?'animate-spin':''} /><span>雲端更新</span></button>
                                <button onClick={handleLocalPicker} disabled={isSyncing} className="flex-1 flex items-center justify-center space-x-2 bg-slate-700 hover:bg-purple-900/30 text-white py-2 rounded-md border border-slate-600 transition-all text-xs font-bold"><HardDrive size={14} className="text-purple-400" /><span>本地資源</span></button>
                            </div>
                            <div className="flex gap-2">
                                {importReport && (
                                    <button onClick={() => setShowReport(true)} className="flex-1 flex items-center justify-center space-x-2 bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-md border border-slate-600 text-xs font-bold transition-all">
                                        <ClipboardList size={14} className="text-blue-400" /><span>匯入紀錄</span>
                                    </button>
                                )}
                                <button onClick={() => setShowClearModal(true)} className={`${importReport ? 'flex-1' : 'w-full'} flex items-center justify-center space-x-2 bg-slate-700 hover:bg-red-900/30 text-white py-2 rounded-md border border-slate-600 text-xs font-bold transition-all`}><Trash2 size={14} className="text-red-500" /><span>清空資料庫</span></button>
                            </div>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col min-w-0 bg-slate-900 relative">
                        <header className="h-16 bg-slate-800 border-b border-slate-700 flex items-center justify-between px-6 flex-shrink-0 z-30">
                            <div className="flex items-center space-x-4 flex-1 min-w-0">
                                <button onClick={()=>setIsSidebarOpen(!isSidebarOpen)} className="p-2 hover:bg-slate-700 rounded-md text-slate-400 transition-colors">{isSidebarOpen ? <PanelLeftClose size={20}/> : <PanelLeftOpen size={20}/>}</button>
                                <button onClick={handleGoUp} disabled={activeCategory==='全部'} className={`p-2 rounded-md ${activeCategory==='全部'?'text-slate-600 cursor-not-allowed':'text-slate-400 hover:bg-slate-700'}`}><ArrowLeft size={20}/></button>
                                <div className="text-slate-300 font-bold truncate text-sm hidden sm:block">{activeCategory === '全部' ? '所有檔案' : activeCategory.split('/').join(' / ')}</div>
                            </div>
                            <div className="flex items-center space-x-2">
                                <SearchMenu searchQuery={searchQuery} onSearchChange={(e)=>setSearchQuery(e.target.value)} onClear={()=>setSearchQuery('')} />
                                <DisplaySettingsMenu sortOption={sortOption} setSortOption={setSortOption} filterType={filterType} setFilterType={setFilterType} />
                                <div className="flex bg-slate-700 p-1 rounded-md border border-slate-600">
                                    <button onClick={()=>setViewMode('list')} className={`p-1.5 rounded ${viewMode==='list'?'bg-slate-600 text-blue-400 shadow-sm':'text-slate-500 hover:text-slate-300'}`}><LayoutList size={18}/></button>
                                    <button onClick={()=>setViewMode('grid')} className={`p-1.5 rounded ${viewMode==='grid'?'bg-slate-600 text-blue-400 shadow-sm':'text-slate-500 hover:text-slate-300'}`}><LayoutGrid size={18}/></button>
                                </div>
                            </div>
                        </header>
                        <div className="flex-1 bg-slate-900 relative"><VirtualGallery items={displayItems} viewMode={viewMode} onItemClick={(f)=>setViewingFile(f)} onFolderClick={handleCategorySelect} /></div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
